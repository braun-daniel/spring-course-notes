<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="description" content="Summary of the Spring Professional Course.">
<meta name="keywords" content="Spring, Course, Professional">
<meta name="author" content="Daniel Kojic">
<title>Spring Professional: Course Summary</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Spring Professional: Course Summary</h1>
<div class="details">
<span id="author" class="author">Daniel Kojic</span><br>
<span id="email" class="email"><a href="mailto:dan.kojic@gmail.com">dan.kojic@gmail.com</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_what_is_the_spring_framework">1.1. What is the Spring Framework?</a></li>
<li><a href="#_spring_is_a_container">1.2. Spring is a Container</a></li>
<li><a href="#_what_is_spring_used_for">1.3. What is Spring Used For?</a></li>
</ul>
</li>
<li><a href="#_dependency_injection_part_1">2. Dependency Injection - Part 1</a>
<ul class="sectlevel2">
<li><a href="#_spring_quick_start">2.1. Spring quick start</a></li>
<li><a href="#_creating_an_application_context">2.2. Creating an application context</a></li>
<li><a href="#_multiple_configuration_files">2.3. Multiple Configuration Files</a></li>
<li><a href="#_bean_scope">2.4. Bean scope</a></li>
<li><a href="#_summary">2.5. Summary</a></li>
</ul>
</li>
<li><a href="#_dependency_injection_part_2">3. Dependency Injection - Part 2</a>
<ul class="sectlevel2">
<li><a href="#_external_properties">3.1. External Properties</a></li>
<li><a href="#_profiles">3.2. Profiles</a></li>
<li><a href="#_spring_expression_language_spel">3.3. Spring Expression Language (SPEL)</a></li>
<li><a href="#_proxying">3.4. Proxying</a></li>
<li><a href="#_summary_2">3.5. Summary</a></li>
</ul>
</li>
<li><a href="#_annotations">4. Annotations</a>
<ul class="sectlevel2">
<li><a href="#_annotation_based_configuration">4.1. Annotation-based Configuration</a></li>
<li><a href="#_best_practices_for_component_scanning">4.2. Best practices for component-scanning</a></li>
<li><a href="#_java_config_versus_annotations">4.3. Java Config versus annotations</a></li>
<li><a href="#__postconstruct_and_predestroy">4.4. @PostConstruct and @PreDestroy</a></li>
<li><a href="#_stereotypes_and_meta_annotations">4.5. Stereotypes and meta annotations</a></li>
<li><a href="#__resource">4.6. @Resource</a></li>
<li><a href="#_standard_annotations_jsr_330">4.7. Standard Annotations (JSR 330)</a></li>
<li><a href="#_summary_3">4.8. Summary</a></li>
</ul>
</li>
<li><a href="#_dependency_injection_using_xml">5. Dependency Injection Using XML</a>
<ul class="sectlevel2">
<li><a href="#_writing_bean_definitions_in_xml">5.1. Writing bean definitions in XML</a></li>
<li><a href="#_creating_an_application_context_2">5.2. Creating an application context</a></li>
<li><a href="#_controlling_bean_behavior">5.3. Controlling Bean Behavior</a></li>
<li><a href="#_namespaces">5.4. Namespaces</a></li>
</ul>
</li>
<li><a href="#_bean_lifecycle">6. Bean Lifecycle</a>
<ul class="sectlevel2">
<li><a href="#_introduction_2">6.1. Introduction</a></li>
<li><a href="#_the_initialization_phase">6.2. The initialization phase</a></li>
<li><a href="#_the_use_phase">6.3. The use phase</a></li>
<li><a href="#_the_destruction_phase">6.4. The destruction phase</a></li>
</ul>
</li>
<li><a href="#_testing_spring_applications">7. Testing Spring Applications</a>
<ul class="sectlevel2">
<li><a href="#_test_driven_development">7.1. Test Driven Development</a></li>
<li><a href="#_unit_testing_without_spring">7.2. Unit testing without Spring</a></li>
<li><a href="#_integration_testing_with_spring">7.3. Integration Testing with Spring</a></li>
<li><a href="#_testing_with_profiles">7.4. Testing with Profiles</a></li>
<li><a href="#_testing_with_databases">7.5. Testing with Databases</a></li>
<li><a href="#_summary_4">7.6. Summary</a></li>
</ul>
</li>
<li><a href="#_aspect_oriented_programming_aop">8. Aspect Oriented Programming (AOP)</a>
<ul class="sectlevel2">
<li><a href="#_what_problem_does_aop_solve">8.1. What Problem Does AOP Solve?</a></li>
<li><a href="#_core_aop_concepts">8.2. Core AOP Concepts</a></li>
<li><a href="#_quick_start">8.3. Quick Start</a></li>
<li><a href="#_defining_pointcuts">8.4. Defining Pointcuts</a></li>
<li><a href="#_implementing_advice">8.5. Implementing Advice</a></li>
</ul>
</li>
<li><a href="#_data_access">9. Data Access</a>
<ul class="sectlevel2">
<li><a href="#_the_role_of_spring_in_enterprise_data_access">9.1. The Role of Spring in Enterprise Data Access</a></li>
<li><a href="#_spring_s_dataaccessexceptionhierarchy">9.2. Spring&#8217;s DataAccessExceptionHierarchy</a></li>
<li><a href="#_using_test_databases">9.3. Using Test Databases</a></li>
<li><a href="#_implementing_caching">9.4. Implementing Caching</a></li>
<li><a href="#_nosql_databases">9.5. NoSQL databases</a></li>
<li><a href="#_summary_6">9.6. Summary</a></li>
</ul>
</li>
<li><a href="#_jdbc">10. JDBC</a>
<ul class="sectlevel2">
<li><a href="#_problems_with_traditional_jdbc">10.1. Problems with traditional JDBC</a></li>
<li><a href="#_spring_s_jdbctemplate">10.2. Spring’s JdbcTemplate</a></li>
<li><a href="#_query_execution">10.3. Query Execution</a></li>
<li><a href="#_inserts_and_updates">10.4. Inserts and Updates</a></li>
<li><a href="#_exception_handling">10.5. Exception handling</a></li>
</ul>
</li>
<li><a href="#_transactions">11. Transactions</a>
<ul class="sectlevel2">
<li><a href="#_why_use_transactions">11.1. Why use Transactions?</a></li>
<li><a href="#_java_transaction_management">11.2. Java Transaction Management</a></li>
<li><a href="#_spring_transaction_management">11.3. Spring Transaction Management</a></li>
<li><a href="#_isolation_levels">11.4. Isolation Levels</a></li>
<li><a href="#_transaction_propagation">11.5. Transaction Propagation</a></li>
<li><a href="#_rollback_rules">11.6. Rollback rules</a></li>
<li><a href="#_testing">11.7. Testing</a></li>
</ul>
</li>
<li><a href="#_object_relational_mapping_orm">12. Object Relational Mapping (ORM)</a></li>
<li><a href="#_java_persistence_api_jpa">13. Java Persistence API (JPA)</a>
<ul class="sectlevel2">
<li><a href="#_introduction_to_jpa">13.1. Introduction to JPA</a></li>
<li><a href="#_configuring_jpa_in_spring">13.2. Configuring JPA in Spring</a></li>
<li><a href="#_implementing_jpa_daos">13.3. Implementing JPA DAOs</a></li>
<li><a href="#_spring_data_jpa">13.4. Spring Data – JPA</a></li>
<li><a href="#_summary_7">13.5. Summary</a></li>
</ul>
</li>
<li><a href="#_spring_web">14. Spring Web</a>
<ul class="sectlevel2">
<li><a href="#_introduction_3">14.1. Introduction</a></li>
<li><a href="#_using_spring_in_web_applications">14.2. Using Spring in Web Applications</a></li>
<li><a href="#_overview_of_spring_web">14.3. Overview of Spring Web</a></li>
<li><a href="#_summary_8">14.4. Summary</a></li>
</ul>
</li>
<li><a href="#_rest">15. REST</a>
<ul class="sectlevel2">
<li><a href="#_rest_introduction">15.1. REST introduction</a></li>
<li><a href="#_rest_and_java">15.2. REST and Java</a></li>
<li><a href="#_spring_mvc_support_for_restful_applications">15.3. Spring MVC support for RESTful applications</a></li>
<li><a href="#_summary_9">15.4. Summary</a></li>
</ul>
</li>
<li><a href="#_spring_mvc">16. Spring MVC</a>
<ul class="sectlevel2">
<li><a href="#_request_processing_lifecycle">16.1. Request Processing Lifecycle</a></li>
<li><a href="#_key_artifacts">16.2. Key Artifacts</a></li>
<li><a href="#_quick_start_2">16.3. Quick Start</a></li>
</ul>
</li>
<li><a href="#_spring_boot">17. Spring Boot</a>
<ul class="sectlevel2">
<li><a href="#_what_is_spring_boot">17.1. What is Spring Boot?</a></li>
<li><a href="#_spring_boot_explained">17.2. Spring Boot Explained</a></li>
<li><a href="#_spring_boot_inside_of_a_servlet_container">17.3. Spring Boot inside of a Servlet Container</a></li>
<li><a href="#_ease_of_use_features">17.4. Ease of Use Features</a></li>
<li><a href="#_summary_10">17.5. Summary</a></li>
</ul>
</li>
<li><a href="#_spring_security">18. Spring Security</a>
<ul class="sectlevel2">
<li><a href="#_high_level_security_overview">18.1. High-Level Security Overview</a></li>
<li><a href="#_motivations_of_spring_security">18.2. Motivations of Spring Security</a></li>
<li><a href="#_spring_security_in_a_web_environment">18.3. Spring Security in a Web Environment</a></li>
<li><a href="#_configuring_web_authentication">18.4. Configuring Web Authentication</a></li>
<li><a href="#_using_spring_security_s_tag_libraries">18.5. Using Spring Security&#8217;s Tag Libraries</a></li>
<li><a href="#_method_security">18.6. Method security</a></li>
<li><a href="#_advanced_security_filters">18.7. Advanced security: Filters</a></li>
</ul>
</li>
<li><a href="#_microservices_and_cloud_embeded_systems">19. Microservices and Cloud embeded Systems</a>
<ul class="sectlevel2">
<li><a href="#_what_are_microservices">19.1. What are Microservices?</a></li>
<li><a href="#_challenges_and_implementation">19.2. Challenges and Implementation</a></li>
<li><a href="#_spring_cloud">19.3. Spring Cloud</a></li>
<li><a href="#_summary_11">19.4. Summary</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="link" href="#_introduction">1. Introduction</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_the_spring_framework"><a class="link" href="#_what_is_the_spring_framework">1.1. What is the Spring Framework?</a></h3>
<div class="paragraph">
<p>Spring is an <strong>Open Source</strong>, <strong>Lightweight</strong>, <strong>Container</strong> and <strong>Framework</strong> for building Java enterprise applications.</p>
</div>
<div class="sect3">
<h4 id="_lightweight"><a class="link" href="#_lightweight">1.1.1. Lightweight</a></h4>
<div class="ulist">
<ul>
<li>
<p>Spring applications do not require a Java EE application server (but can be deployed on one).</p>
</li>
<li>
<p>Not invasive</p>
<div class="ulist">
<ul>
<li>
<p>Does not require you to extend framework classes or implement framework interfaces for most usage</p>
</li>
<li>
<p>You write your code as POJOs</p>
</li>
</ul>
</div>
</li>
<li>
<p>Small jars</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_container"><a class="link" href="#_container">1.1.2. Container</a></h4>
<div class="ulist">
<ul>
<li>
<p>Spring as a container for your application objects.</p>
<div class="ulist">
<ul>
<li>
<p>Objects do not have to worry how to find/connect to each other.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring instantiates and dependency injects your objects</p>
<div class="ulist">
<ul>
<li>
<p>Serves as a lifecycle manager</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_framework"><a class="link" href="#_framework">1.1.3. Framework</a></h4>
<div class="ulist">
<ul>
<li>
<p>Spring provides framework classes to simplify working with lower-level technologies e.g.,</p>
<div class="ulist">
<ul>
<li>
<p>JDBC, JMS, AMQP, Transactions, ORM / JPA, NoSQL, Security, Web, Tasks, Scheduling, Mail, Files, XML/JSON Marshalling, Remoting, REST services, SOAP services, Mobile, Social, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>Framework classes for abstraction of lower-level technologies.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_is_a_container"><a class="link" href="#_spring_is_a_container">1.2. Spring is a Container</a></h3>
<div class="paragraph">
<p>Spring provides support for assembling such an application system from its parts.<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Parts do not worry about finding each other.</p>
</li>
<li>
<p>Any part can easily be swapped out.</p>
</li>
<li>
<p>Parts are POJOs.</p>
</li>
<li>
<p>Interface usage allows swapping backing implementations.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_spring_used_for"><a class="link" href="#_what_is_spring_used_for">1.3. What is Spring Used For?</a></h3>
<div class="paragraph">
<p>Spring provides infrastructural support for developing enterprise Java applications. It deals with the plumbing so you can focus on solving the domain problem. It provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Web Interfaces</p>
</li>
<li>
<p>Messaging</p>
</li>
<li>
<p>Persistence</p>
</li>
<li>
<p>Batch</p>
</li>
<li>
<p>Integration</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dependency_injection_part_1"><a class="link" href="#_dependency_injection_part_1">2. Dependency Injection - Part 1</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Introducing the Spring Application Context and Spring&#8217;s Java Configuration capability.<br></p>
</div>
<div class="sect2">
<h3 id="_spring_quick_start"><a class="link" href="#_spring_quick_start">2.1. Spring quick start</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Application classes get injected into Spring Application Context</p>
</li>
<li>
<p>Configuration Instructions get injected into Application Context.</p>
</li>
<li>
<p>Spring Application Context creates Fully configured App.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Application classes.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class TransferServiceImpl implements TransferService {
	public TransferServiceImpl(AccountRepository ar) { <b class="conum">(1)</b>
		this.accountRepository = ar; }
	}
	...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Needed to perform money transfers between accounts.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Configuration Instructions.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class ApplicationConfig {
	@Bean
	public TransferService transferService() {
		return new transferServiceImpl(accountRepository());
	}

	@Bean
	public AccountRepository accountRepository() {
		return new AccountRepository(dataSource());
	}

	@Bean
	public DataSource dataSource() {
		return new new BasicDataSource());
	}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Creating and using the app.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// Create the application from the configuration
ApplicationContext context = SpringApplication.run( ApplicationConfig.class );

// Look up the application service interface
TransferService service = (TransferService) context.getBean(“transferService”); <b class="conum">(1)</b>

// Use the application
service.transfer(new MonetaryAmount(“300.00”), “1”, “2”);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Bean ID based on method name.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Accessing a Bean.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">ApplicationContext context = SpringApplication.run(...); <b class="conum">(1)</b>

// Classic way: cast is needed
TransferService ts1 = (TransferService) context.getBean(“transferService”);

// Use typed method to avoid cast
TransferService ts2 = context.getBean(“transferService”, TransferService.class);

// No need for bean id if type is unique
TransferService ts3 = context.getBean(TransferService.class );</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Inject configuration classes into the run method e.g. <code>AppConfig.class</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_creating_an_application_context"><a class="link" href="#_creating_an_application_context">2.2. Creating an application context</a></h3>
<div class="paragraph">
<p>Spring application contexts can be <strong>bootstrapped in any environment</strong>, including JUnit, a Web application
and Standalone applications.</p>
</div>
<div class="listingblock">
<div class="title">Using an Application Context Inside a JUnit System Test.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class TransferServiceTests {
	private TransferService service;

	@Before public void setUp() { <b class="conum">(1)</b>
		// Create the application from the configuration
		ApplicationContext context = SpringApplication.run( ApplicationConfig.class )
		// Look up the application service interface
		service = context.getBean(TransferService.class);
	}

	@Test public void moneyTransfer() { <b class="conum">(2)</b>
		Confirmation receipt = service.transfer(new MonetaryAmount(“300.00”), “1”, “2”));
		Assert.assertEquals(receipt.getNewBalance(), “500.00”);
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Bootstraps the system to test.</p>
</li>
<li>
<p>Tests the system.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_configuration_files"><a class="link" href="#_multiple_configuration_files">2.3. Multiple Configuration Files</a></h3>
<div class="sect3">
<h4 id="_general"><a class="link" href="#_general">2.3.1. General</a></h4>
<div class="paragraph">
<p>Devide your configuration into <strong>multiple configuration</strong> classes using <code>@Import</code>. This defines a <strong>single Application Context</strong> with beans sourced from <strong>mutliple files</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@Import({InfrastructureConfig.class, WebConfig.class })
public class ApplicationConfig { ... }

@Configuration
public class InfrastructureConfig { ... }

@Configuration
public class WebConfig { ... }</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Best Practice</dt>
<dd>
<p>Separate out “application” beans e.g., services from “infrastructure” beans e.g., datasources. Infrastructure often changes between environments.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_referencing_beans_from_another_file"><a class="link" href="#_referencing_beans_from_another_file">2.3.2. Referencing beans from another file</a></h4>
<div class="paragraph">
<p>Either use <code>@Autowired</code> to reference bean defined in a separate configuration file or define Define <code>@Bean</code> method parameters.</p>
</div>
<div class="listingblock">
<div class="title">Autowired.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@Import( InfrastructureConfig.class )
public class ApplicationConfig {

	@Autowired DataSource dataSource;

	@Bean
	public AccountRepository accountRepository() {
		return new JdbcAccountRepository( dataSource ); }
	}
}

@Configuration
public class ApplicationConfig {

	@Bean
	public DataSource dataSource() {
		return ...;
	}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@Import( InfrastructureConfig.class )
public class ApplicationConfig {

	@Bean
	public AccountRepository accountRepository( DataSource dataSource ) { <b class="conum">(1)</b>
		return new JdbcAccountRepository( dataSource );
	}
}

@Configuration
public class InfrastructureConfig {

	@Bean
	public DataSource dataSource() {
		return ...;
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Spring matches this by type.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
It is not illegal to define the same bean more than once. <strong>You get the last bean Spring sees</strong> defined.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bean_scope"><a class="link" href="#_bean_scope">2.4. Bean scope</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">singleton <em>(default)</em></dt>
<dd>
<p>A single instance is used.</p>
</dd>
<dt class="hdlist1">prototype</dt>
<dd>
<p>A new instance is created each time the bean is referenced.</p>
</dd>
<dt class="hdlist1">session <em>(web environment)</em></dt>
<dd>
<p>A new instance is created once per user session.</p>
</dd>
<dt class="hdlist1">request <em>(web environment)</em></dt>
<dd>
<p>A new instance is created once per request.</p>
</dd>
<dt class="hdlist1">custom scope name <em>(advanced feature)</em></dt>
<dd>
<p>You define your own rules and a new scope name.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_summary"><a class="link" href="#_summary">2.5. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Your object is handed what it needs to work</p>
<div class="ulist">
<ul>
<li>
<p>Frees it from the burden of resolving its dependencies</p>
</li>
<li>
<p>Simplifies your code, improves code reusability</p>
</li>
</ul>
</div>
</li>
<li>
<p>Promotes programming to interfaces</p>
<div class="ulist">
<ul>
<li>
<p>Conceals implementation details of dependencies</p>
</li>
</ul>
</div>
</li>
<li>
<p>Improves testability</p>
<div class="ulist">
<ul>
<li>
<p>Dependencies easily stubbed out for unit testing</p>
</li>
</ul>
</div>
</li>
<li>
<p>Allows for centralized control over object lifecycle</p>
<div class="ulist">
<ul>
<li>
<p>Opens the door for new possibilities</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dependency_injection_part_2"><a class="link" href="#_dependency_injection_part_2">3. Dependency Injection - Part 2</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_external_properties"><a class="link" href="#_external_properties">3.1. External Properties</a></h3>
<div class="paragraph">
<p>Bad practice to use hard coded properties e.g., db username. Instead externalize properties. Either use the <strong>Environment object</strong> or <strong>@Value</strong> annotation.</p>
</div>
<div class="sect3">
<h4 id="_environment_object"><a class="link" href="#_environment_object">3.1.1. Environment Object</a></h4>
<div class="ulist">
<ul>
<li>
<p>Environment object used to obtain properties from runtime environment</p>
</li>
<li>
<p>Properties from many sources:</p>
<div class="ulist">
<ul>
<li>
<p>JVM System Properties</p>
</li>
<li>
<p>Java Properties Files</p>
</li>
<li>
<p>Servlet Context Parameters</p>
</li>
<li>
<p>System Environment Variables</p>
</li>
<li>
<p>JNDI</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Using the Environment object to get the properties.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Autowired public Environment

@Bean public DataSource dataSource() {
	DataSource ds = new BasicDataSource();
	ds.setDriverClassName( env.getProperty(“db.driver”));
	ds.setUrl( env.getProperty( “db.url” ));
	ds.setUser( env.getProperty( “db.user” ));
	ds.setPassword( env.getProperty( “db.password” ));
	return ds;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__value"><a class="link" href="#__value">3.1.2. @Value</a></h4>
<div class="listingblock">
<div class="title">Using the <code>@Value</code> annotation to get the properties.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class ApplicationConfig {

	@Bean
	public DataSource dataSource(
			@Value("${db.driver}") String dbDriver,
			@Value("${db.url}") String dbUrl,
			@Value("${db.user}") String dbUser,
			@Value("${db.password}") String dbPassword) {
		DataSource ds = new BasicDataSource();
		ds.setDriverClassName( dbDriver);
		ds.setUrl( dbUrl);
		ds.setUser( dbUser);
		ds.setPassword( dbPassword ));
		return ds;
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_property_sources"><a class="link" href="#_property_sources">3.1.3. Property Sources</a></h4>
<div class="ulist">
<ul>
<li>
<p>Environment obtains values from “property sources”</p>
<div class="ulist">
<ul>
<li>
<p>System properties &amp; Environment variables populated automatically</p>
</li>
<li>
<p>Use <code>@PropertySources</code> to contribute additional properties</p>
</li>
<li>
<p>Available resource prefixes: <code>classpath:</code> <code>file:</code> <code>http:</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@PropertySource ( “classpath:/com/organization/config/app.properties” )
public class ApplicationConfig {
	...
	@Bean
	public static PropertySourcesPlaceholderConfigurer propertySourcesPlaceholderConfigurer() {
		return new PropertySourcesPlaceholderConfigurer(); <b class="conum">(1)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>@PropertySource</code> ignored unless this bean declared.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
This is a static bean. Such beans are created first. It ensures property-sources are read before any <code>@Configuration</code> bean using <code>@Value</code> is initialized.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Placeholders</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>${&#8230;&#8203;}</code> placeholders in a @PropertySource are resolved against existing properties.</p>
<div class="ulist">
<ul>
<li>
<p>Such as System properties &amp; Environment variables.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@PropertySource ( “classpath:/com/acme/config/app-${ENV}.properties” )</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>app-dev.properties</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>db.user=transfer-app
db.password=secret45</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>app-prod.properties</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>db.user=transfer-app
db.password=secret46</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_profiles"><a class="link" href="#_profiles">3.2. Profiles</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Grouping</dt>
<dd>
<p>Beans can be grouped into Profiles.</p>
<div class="ulist">
<ul>
<li>
<p>Profiles can <strong>represent purpose</strong>: “web”,“offline”</p>
</li>
<li>
<p><strong>Or environment</strong>: “dev”, “qa”, “uat”, “prod”</p>
</li>
<li>
<p>Beans <strong>included/excluded</strong> based on profile membership</p>
<div class="ulist">
<ul>
<li>
<p>Beans with <strong>no profile are always available</strong>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Simply use the <code>@Profile("sample_profile")</code> annotation either on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Configuration</code> classes: All beans in that class belong to that profile.</p>
</li>
<li>
<p><code>@Bean</code> methods: Only this bean belongs to that profile.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean(name="dataSource") <b class="conum">(1)</b>
@Profile("dev")<b class="conum">(2)</b>
public DataSource dataSourceForDev() { ... }

@Bean(name="dataSource") <b class="conum">(1)</b>
@Profile("prod") <b class="conum">(2)</b>
public DataSource dataSourceForProd() { ... }</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Same bean name.</p>
</li>
<li>
<p>Different profiles.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;context-param&gt;
	&lt;param-name&gt;spring.profiles.active&lt;/param-name&gt;
	&lt;param-value&gt;jpa,web&lt;/param-value&gt;
&lt;/context-param&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Programmatically on ApplicationContext: Simply set <code>spring.profiles.active</code> system property before instantiating <code>ApplicationContext</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_spring_expression_language_spel"><a class="link" href="#_spring_expression_language_spel">3.3. Spring Expression Language (SPEL)</a></h3>
<div class="sect3">
<h4 id="__value_2"><a class="link" href="#__value_2">3.3.1. @Value</a></h4>
<div class="listingblock">
<div class="title">Usage</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Value("#{ systemProperties['user.region'] }")
String region; <b class="conum">(1)</b>

@Bean public TaxCalculator taxCalculator1() {
	TaxCalculator tc = new TaxCalculator();
	tc.setDefaultLocale(region); <b class="conum">(1)</b>
	return tc;
}

@Bean public TaxCalculator taxCalculator2(
			@Value("#{ systemProperties['user.region'] }") String region) { <b class="conum">(2)</b>
	TaxCalculator tc = return new TaxCalculator();
	tc.setDefaultLocale(region);
	return tc;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On field.</p>
</li>
<li>
<p>Or method argument.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Accessing beans.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class StrategyBean {
	private KeyGenerator gen = new UuidGenerator();
	public KeyGenerator getKeyGenerator() {
		return gen;
	}
}

@Configuration
class StrategyConfig {
	@Bean public StrategyBean strategyBean() {
		return new StrategyBean();
	}
}

@Configuration
class AnotherConfig {
	@Value("#{strategyBean.keyGenerator}") KeyGenerator kgen;
	...
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>EL Attributes can be:</p>
<div class="ulist">
<ul>
<li>
<p>Spring beans (like strategyBean)</p>
</li>
<li>
<p>Implicit references</p>
<div class="ulist">
<ul>
<li>
<p>systemProperties and systemEnvironment available by default</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>SpEL allows to create custom functions and references</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_proxying"><a class="link" href="#_proxying">3.4. Proxying</a></h3>
<div class="listingblock">
<div class="title">Spring works with singletons.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public AccountRepository accountRepository() {
	return new JdbcAccountRepository();
}

@Bean
public TransferService transferService() {
	TransferServiceImpl service = new TransferServiceImpl();
	service.setAccountRepository(accountRepository()); <b class="conum">(1)</b>
	return service;
}

@Bean
public AccountService accountService() {
	return new AccountServiceImpl( accountRepository()); <b class="conum">(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Two invocations but spring makes it a single instance.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Child class is the entry point. Java Configuration uses cglib for inheritance-based proxies.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class AppConfig$$EnhancerByCGLIB$ extends AppConfig {
	public AccountRepository accountRepository() {
		// if bean is in the applicationContext, then return bean
		// else call super.accountRepository(), store bean in context, return bean
	}

	public TransferService transferService() {
		// if bean is in the applicationContext, then return bean
		// else call super.transferService(), store bean in context, return bean
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_2"><a class="link" href="#_summary_2">3.5. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Property values are easily externalized using Spring&#8217;s Environment abstraction</p>
</li>
<li>
<p>Profiles are used to group sets of beans</p>
</li>
<li>
<p>Spring Expression Language</p>
</li>
<li>
<p>Spring proxies your <code>@Configuration</code> classes to allow for scope control.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annotations"><a class="link" href="#_annotations">4. Annotations</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Annotations for Dependency Injection and Interception - Component scanning and auto-injection.</p>
</div>
<div class="sect2">
<h3 id="_annotation_based_configuration"><a class="link" href="#_annotation_based_configuration">4.1. Annotation-based Configuration</a></h3>
<div class="sect3">
<h4 id="_before"><a class="link" href="#_before">4.1.1. Before</a></h4>
<div class="ulist">
<ul>
<li>
<p>Separation of concerns</p>
</li>
<li>
<p>Java-based dependency injection.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Configuration is external to bean-class.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class TransferModuleConfig {
	@Bean public TransferService transService() {
		TransferServiceImpl service = new TransferServiceImpl();
		service.setAccountRepository(accountRepository());
		return service;
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_after"><a class="link" href="#_after">4.1.2. After</a></h4>
<div class="listingblock">
<div class="title">Annotation-based configuration within bean-class</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Component
public class TransferServiceImpl implements TransferService { <b class="conum">(1)</b>
	@Autowired
	public TransferServiceImpl(AccountRepository repo) {
		this.accountRepository = repo; <b class="conum">(2)</b>
	}
}

@Configuration @ComponentScan ( “com.bank” ) <b class="conum">(3)</b>
public class AnnotationConfig {
	// no bean definition needed anymore
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Bean id derived from class name.</p>
</li>
<li>
<p>Annotations embedded with POJO.</p>
</li>
<li>
<p>Find <code>@Component</code> classes within designated (sub)packages.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="__autowired"><a class="link" href="#__autowired">4.1.3. @Autowired</a></h4>
<div class="paragraph">
<p>Where a <strong>unique dependency of correct type must exist</strong>. Injection via. <strong>Constructor</strong>, <strong>Method</strong> and <strong>Field</strong> (even <code>private</code>, but hard to unit test). Injection can either be <strong>required (default) or not</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Use required attribute to override default behaviour.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Autowired(required=false)
public void setAccountRepository(AccountRepository a) { <b class="conum">(1)</b>
	// Use required attribute to override default behavior
 	this.accountRepository = a;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Only inject if dependency exists.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Optional&lt;T&gt; (Java 8 only). Was introduced to reduce null pointer errors.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Autowired
Optional&lt;AccountService&gt; accountService;

public void doSomething() {
	accountService.ifPresent(s -&gt; {...});
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_constructor_vs_setter_dependency_injection"><a class="link" href="#_constructor_vs_setter_dependency_injection">4.1.4. Constructor vs Setter Dependency Injection</a></h4>
<table class="tableblock frame-topbot grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Constructor</th>
<th class="tableblock halign-left valign-top">Setter</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concise (pass several params at once)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inherited automatically</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mandatory dependencies</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional / changeable dependencies</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immutable dependencies</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Circular dependencies</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Be consistent.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_disambiguation_qualifier"><a class="link" href="#_disambiguation_qualifier">4.1.5. Disambiguation (@Qualifier)</a></h4>
<div class="paragraph">
<p>Prevent disambiguities. <code>NoSuchBeanDefinitionException</code> is thrown at <strong>start-up</strong> in case no unique bean is defined. Use the <code>@Qualifier</code> annotation and explicit bean ids to refer to these. Also available with <strong>method injection and field injection</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Autowired resolution rules</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Look for unique bean of required type</p>
</li>
<li>
<p>Use <code>@Qualifier</code> if supplied</p>
</li>
<li>
<p>Try to find a matching bean by name</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Use of <code>@Qualifier</code> annotation.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Component("transferService")
public class TransferServiceImpl implements TransferService {
	@Autowired
	public TransferServiceImpl(@Qualifier("jdbcAccountRepository")
			AccountRepository accountRepository) {...}
	...
}

@Component("jdbcAccountRepository")
public class JdbcAccountRepository implements AccountRepository {...}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__value_3"><a class="link" href="#__value_3">4.1.6. @Value</a></h4>
<div class="paragraph">
<p>Use <code>$</code> variables or SpEL.</p>
</div>
<div class="listingblock">
<div class="title">Constructor injection</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Autowired
public TransferServiceImpl(@Value("${daily.limit}") int max) {...}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Method injection</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java"> @Autowired
public void setDailyLimit(@Value("${daily.limit}") int max) {...}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Field injection</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Value("#{systemEnvironment['DAILY_LIMIT']}")
private int maxTransfersPerDay;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Provide <strong>fall-back</strong> values.</p>
</div>
<div class="listingblock">
<div class="title">Use colon with <code>$</code> variables.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Autowired
public TransferServiceImpl(@Value("${daily.limit:100000}") int max) {...}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Use ?: (Elvis operator) for SpEL.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Autowired
public setLimit(@Value("#{environment['daily.limit'] ?: 100000}") int max) {...}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_component_names"><a class="link" href="#_component_names">4.1.7. Component Names</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">When not specified</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Names are auto-generated</p>
<div class="ulist">
<ul>
<li>
<p>De-capitalized non-qualified classname by default</p>
</li>
<li>
<p>But will pick up implementation details from classname</p>
</li>
</ul>
</div>
</li>
<li>
<p>Recommendation: never rely on generated names!</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">When specified</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Allow disambiguation when 2 bean classes implement the same interface</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>IMPORANT: Avoid using qualifiers when possible. Usually rare to have 2 beans of same type in ApplicationContext.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_best_practices_for_component_scanning"><a class="link" href="#_best_practices_for_component_scanning">4.2. Best practices for component-scanning</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Components are scanned at startup</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Jar dependencies also scanned!</p>
</li>
<li>
<p>Could result in slower startup time if too many files scanned</p>
<div class="ulist">
<ul>
<li>
<p>Especially for large applications</p>
</li>
<li>
<p>A few seconds slower in worst case</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Use the most specific packages when using <code>@ComponentScan</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ComponentScan({"com.bank.app.repository", "com.bank.app.service", "com.bank.app.controller"})</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_java_config_versus_annotations"><a class="link" href="#_java_config_versus_annotations">4.3. Java Config versus annotations</a></h3>
<div class="sect3">
<h4 id="_annotation"><a class="link" href="#_annotation">4.3.1. Annotation</a></h4>
<div class="paragraph">
<p>Nice for frequently changing beans.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Pros</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Single place to edit (just the class)</p>
</li>
<li>
<p>Allows for very rapid development</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Cons</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Configuration spread across your code base</p>
<div class="ulist">
<ul>
<li>
<p>Harder to debug/maintain</p>
</li>
</ul>
</div>
</li>
<li>
<p>Only works for your own code</p>
</li>
<li>
<p>Merges configuration and code (bad sep. of concerns)</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Annotation.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Component("transferService")
@Scope("prototype")
@Profile("dev")
@Lazy(false)
public class TransferServiceImpl implements TransferService {
	@Autowired
	public TransferServiceImpl(AccountRepository accRep){...}
	...
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_java_configuration"><a class="link" href="#_java_configuration">4.3.2. Java Configuration</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Pros</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Is centralized in one (or a few) places</p>
</li>
<li>
<p>Write any Java code you need</p>
</li>
<li>
<p>Strong type checking enforced by compiler (and IDE)</p>
</li>
<li>
<p>Can be used for all classes (not just your own)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Cons</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>More verbose than annotations</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Java Configuration.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
@Scope("prototype")
@Profile("dev")
@Lazy(false)
public TransferService transferService() {
	return new TransferServiceImpl(accountRepository());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__postconstruct_and_predestroy"><a class="link" href="#__postconstruct_and_predestroy">4.4. @PostConstruct and @PreDestroy</a></h3>
<div class="paragraph">
<p>Add behavior at startup with <code>@PostConstruct</code> and shutdown with <code>@PreDestroy</code> method annotations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Annotated methods can have any visibility but must take no parameters and only return void.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class JdbcAccountRepository {
	@PostConstruct <b class="conum">(1)</b>
	void populateCache(){...}

	@PreDestroy <b class="conum">(2)</b>
	void clearCache(){...}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Called after startup and after all dependencies got injected.</p>
</li>
<li>
<p>Called at shutdown prior to destroying the bean instance.</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Beans can be created in the normal way</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Returned from @Bean methods</p>
</li>
<li>
<p>Found and created by the component-scanner</p>
</li>
<li>
<p>Spring invokes them automatically</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">These are not Spring annotations</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Defined by JSR-250, part of Java since Java 6</p>
</li>
<li>
<p>In javax.annotation package</p>
</li>
<li>
<p>Also supported by EJB3</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">PostConstruct</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Called after setter methods got called</p>
</li>
<li>
<p>Start &#8594; Constructor called &#8594; Setter(s) called &#8594; @PostConstruct called</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">PreDestroy</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Called when an ApplicationContext is closed</p>
<div class="ulist">
<ul>
<li>
<p>If application (JVM) exits normally</p>
</li>
<li>
<p>Useful for releasing resources &amp; 'cleaning up'</p>
</li>
<li>
<p>Not called for prototype beans</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>ApplicationContext.close()</code> triggers the <code>@PreDestroy</code>.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Bean alternative</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>@Bean properties for classes you didn&#8217;t write and can&#8217;t annotate</p>
</li>
<li>
<p>@PostConstruct/@PreDestroy for your own classes</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Bean Alternative: <code>initMethod</code> and <code>destroyMethod</code>.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean (initMethod="populateCache”, destroyMethod="clearCache")
public AccountRepository accountRepository() {...}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stereotypes_and_meta_annotations"><a class="link" href="#_stereotypes_and_meta_annotations">4.5. Stereotypes and meta annotations</a></h3>
<div class="paragraph">
<p>Component scanning also checks for annotations that are themselves annotated with @Component (stereotype annotations).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@Component</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">@Service</dt>
<dd>
<p>Service classes</p>
</dd>
<dt class="hdlist1">@Repository</dt>
<dd>
<p>Data access classes</p>
</dd>
<dt class="hdlist1">@Controller</dt>
<dd>
<p>Web classes (Spring Mvc)</p>
</dd>
<dt class="hdlist1">@Configuration</dt>
<dd>
<p>Java Configuration</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">Meta Annotations</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Annotation which can be used to annotate other annotations</p>
<div class="ulist">
<ul>
<li>
<p>e.g. all service beans should be configurable using component scanning and be transactional</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Meta Annotation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@Service @Transactional(timeout=60)
public @interface MyTransactionalService {
	String value() default "";
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__resource"><a class="link" href="#__resource">4.6. @Resource</a></h3>
<div class="paragraph">
<p>Identifies dependencies by name (Spring Bean name), not by type. If no name is provided, it first checks the property/field name and the falls back to type checking. It supports only setter and field injection.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@Autowired</dt>
<dd>
<p>type then name</p>
</dd>
<dt class="hdlist1">@Resource</dt>
<dd>
<p>name then type</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_standard_annotations_jsr_330"><a class="link" href="#_standard_annotations_jsr_330">4.7. Standard Annotations (JSR 330)</a></h3>
<div class="paragraph">
<p>Also known as <code>@Inject</code>. Is a subset of the @Autowired annotation. <code>@Named</code> annotations are also scanned by the component scan.</p>
</div>
</div>
<div class="sect2">
<h3 id="_summary_3"><a class="link" href="#_summary_3">4.8. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring’s configuration directives can be written using Java, annotations, or XML (next)</p>
</li>
<li>
<p>You can mix and match Java, annotations, and XML as you please</p>
</li>
<li>
<p>Autowiring with @Component allows for almost empty Java configuration files</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dependency_injection_using_xml"><a class="link" href="#_dependency_injection_using_xml">5. Dependency Injection Using XML</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_writing_bean_definitions_in_xml"><a class="link" href="#_writing_bean_definitions_in_xml">5.1. Writing bean definitions in XML</a></h3>
<div class="listingblock">
<div class="title">Example</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;beans profile=“prod”&gt; <b class="conum">(1)</b>
	&lt;bean id=“transferService1” class=“com.acme.TransferServiceImpl”&gt;
		&lt;property name=“repository” ref=“accountRepository” /&gt; <b class="conum">(2)</b>
	&lt;/bean&gt;

	&lt;bean id=“transferService2” class=“com.acme.TransferServiceImpl”&gt;
		&lt;constructor-arg ref=“accountRepository”/&gt; <b class="conum">(3)</b>
		&lt;constructor-arg ref=“customerRepository”/&gt; <b class="conum">(3)</b>
	&lt;/bean&gt;

	&lt;bean id=“service1” class=“com.acme.ServiceImpl”&gt;
		&lt;property name=“stringProperty” value=“foo” /&gt; <b class="conum">(4)</b>
	&lt;/bean&gt;

	&lt;import resource=“db-config.xml” /&gt; <b class="conum">(5)</b>

	&lt;bean id=“service2” class=“com.acme.ServiceImpl”
			init-method="setup" destroy-method="clear" /&gt; <b class="conum">(6)</b>

	&lt;bean id=“accountService1” class=“com.acme.ServiceImpl” scope=“prototype” /&gt; <b class="conum">(7)</b>

	&lt;bean id=“accountService2” class=“com.acme.ServiceImpl” lazy-init=“true”&gt; <b class="conum">(8)</b>
	...
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>@Profile</p>
</li>
<li>
<p>Setter injection.</p>
</li>
<li>
<p>Constructor injection. Use <code>index</code> if type is ambiguous.</p>
</li>
<li>
<p>Scalar values.</p>
</li>
<li>
<p>Import other XML files.</p>
</li>
<li>
<p>@PostConstruct @PreDestroy</p>
</li>
<li>
<p>@Scope</p>
</li>
<li>
<p>@Lazy("true")</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Both, setter and constructor injection is combinable. When using scalar values, spring automatically converts types accordingly (Numeric types, BigDecimal, boolean, Date, Locale, Resource).</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_an_application_context_2"><a class="link" href="#_creating_an_application_context_2">5.2. Creating an application context</a></h3>
<div class="paragraph">
<p>Use a Java Configuration class, then use <code>@ImportResource</code> to specify XML files. When using <code>SpringApplication.run(MainConfig.class);</code> just do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@ImportResource( { <b class="conum">(1)</b>
		“classpath:com/acme/application-config.xml”,
		“file:C:/Users/alex/application-config.xml”
})
@Import(DatabaseConfig.class) <b class="conum">(2)</b>
public class MainConfig { ... }</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Multiple files allowed (with prefix).</p>
</li>
<li>
<p>Also combine with @Configuration imports.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_bean_behavior"><a class="link" href="#_controlling_bean_behavior">5.3. Controlling Bean Behavior</a></h3>
<div class="paragraph">
<p>Instead of @PostConstruct and @PreDestroy use <code>init-method</code> and <code>destroy-method</code>. The profile in a <code>&lt;beans&gt;</code> tag applies to all beans in the element. To use multiple profiles use nested <code>&lt;beans&gt;</code></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Same rules: method can have any visibility, must take no parameters, must return void. Called after dependency injection.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Using multiple profiles.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;beans xmlns=http://www.springframework.org/schema/beans ...&gt;
	&lt;bean id="rewardNetwork" ... /&gt; &lt;!-- Available to all profiles --&gt;
	&lt;beans profile="dev"&gt; ... &lt;/beans&gt;
	&lt;beans profile="prod"&gt; ... &lt;/beans&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_namespaces"><a class="link" href="#_namespaces">5.4. Namespaces</a></h3>
<div class="paragraph">
<p>The <strong>default namespace</strong> in a Spring configuration file is typically the <strong>“beans”</strong> namespace. Other namespaces are available: aop (Aspect Oriented Programming), tx (transactions), util, jms, context. They allow <strong>hiding of actual bean definitions</strong>. Use the <strong>STS XML editor namespaces tab</strong> to prevent typos. <strong>Do not use Schema Version Numbers</strong> to ease the migration to the next spring version.</p>
</div>
<div class="listingblock">
<div class="title">Namespace example.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;jdbc:embedded-database id="dataSource" type="HSQL"&gt;
	&lt;jdbc:script location="classpath:rewards/testdb/schema.db"/&gt;
	&lt;jdbc:script location=""classpath:rewards/testdb/test-data.db"/&gt;
&lt;/jdbc:embedded-database&gt;

&lt;context:property-placeholder location=“db-config.properties” /&gt; <b class="conum">(1)</b>

&lt;bean class="org.springframework...PropertySourcesPlaceholderConfigurer"&gt; <b class="conum">(2)</b>
	&lt;property name="location" value="db-config.properties"/&gt;
&lt;/bean&gt;

&lt;bean id=“dataSource” class=“com.oracle.jdbc.pool.OracleDataSource”&gt;  <b class="conum">(3)</b>
	&lt;property name=“URL” value=“${dbUrl}” /&gt;
	&lt;property name=“user” value=“${dbUserName}” /&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This instead of&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;this</p>
</li>
<li>
<p>Use it here</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Equivalent to <code>@PropertySource ( “classpath:/com/acme/config/app-${ENV}.properties” )</code></div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;import resource="classpath:config/${current.env}-config.xml"/&gt;

&lt;context:property-placeholder properties-ref=”configProps”/&gt;

&lt;beans profile="dev"&gt;
	&lt;util:properties id="configProps" location="config/app-dev.properties"&gt;
&lt;/beans&gt;

&lt;beans profile="prod"&gt;
	&lt;util:properties id="configProps" location="config/app-prod.properties"&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Equivalent to <code>@ComponentScan( { “com.acme.app.repository”, com.acme.app.service”, “com.acme.app.controller” })</code></div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;context:component-scan base-package=“com.acme.app.repository, com.acme.app.service, com.acme.app.controller” /&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bean_lifecycle"><a class="link" href="#_bean_lifecycle">6. Bean Lifecycle</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Using Bean Pre- and Post-Processors.</p>
</div>
<div class="sect2">
<h3 id="_introduction_2"><a class="link" href="#_introduction_2">6.1. Introduction</a></h3>
<div class="paragraph">
<p>Initialization &#8594; Use &#8594; Destruction</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Initialization</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Prepares for use</p>
</li>
<li>
<p>Application services</p>
<div class="ulist">
<ul>
<li>
<p>Are created</p>
</li>
<li>
<p>Configured</p>
</li>
<li>
<p>May allocate system resources</p>
</li>
</ul>
</div>
</li>
<li>
<p>Application is not usable until this phase is complete</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Use</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Used by clients</p>
</li>
<li>
<p>Application services</p>
<div class="ulist">
<ul>
<li>
<p>Process client requests</p>
</li>
<li>
<p>Carry out application behaviors</p>
</li>
</ul>
</div>
</li>
<li>
<p>99.99% of the time is spent in this phase</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Destruction</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Shuts down</p>
</li>
<li>
<p>Application services</p>
<div class="ulist">
<ul>
<li>
<p>Release any systemresources</p>
</li>
<li>
<p>Are eligible for garbage collection</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_the_initialization_phase"><a class="link" href="#_the_initialization_phase">6.2. The initialization phase</a></h3>
<div class="paragraph">
<p>When <code>SpringApplication.run(&#8230;&#8203;)</code> returns the initialization phase completes.</p>
</div>
<div id="bean_init" class="imageblock">
<div class="content">
<img src="./img/bean_initialization.png" alt="bean initialization">
</div>
<div class="title">Figure 1. Bean initialization steps</div>
</div>
<div class="sect3">
<h4 id="_load_bean_definitions"><a class="link" href="#_load_bean_definitions">6.2.1. Load Bean Definitions</a></h4>
<div class="paragraph">
<p>The @Configuration classes are processed: <strong>@Components are scanned and/or XML files parsed</strong>. Bean definitions added to BeanFactory under its id. Then <code>BeanFactoryPostProcessor</code> beans get invoked. These may change any bean definition.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">BeanFactoryPostProcessor Extension Point</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Applies transformations to bean definitions</p>
<div class="ulist">
<ul>
<li>
<p>Before objects are actually created</p>
</li>
</ul>
</div>
</li>
<li>
<p>Several useful implementations provided in Spring</p>
<div class="ulist">
<ul>
<li>
<p>Reading properties, registering a custom scope &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>You can write your own.</p>
<div class="ulist">
<ul>
<li>
<p>Implement <code>BeanFactoryPostProcessor</code> interface</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_initialize_bean_instances"><a class="link" href="#_initialize_bean_instances">6.2.2. Initialize Bean Instances</a></h4>
<div class="paragraph">
<p>Each bean is <strong>eagerly instantiated</strong> by default in <strong>right order</strong> with its <strong>dependencies injected</strong>.
After dependency injection each bean is post-processed (further configured and initialized. After post processing the bean is fully initialized and ready for use.</p>
</div>
<div class="paragraph">
<p>There are <strong>two types of bean post processors</strong>: Initializers &amp; the rest. Initializers call init methods e.g., @PostConstruct and init-method. All others can be used for additional configuration and may run <strong>before or after the initialize step</strong>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">BeanPostProcessor Extension Point</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An important extension point in Spring</p>
<div class="ulist">
<ul>
<li>
<p>Can modify bean instances in any way</p>
</li>
<li>
<p>Powerful enabling feature</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring provides several implementations</p>
<div class="ulist">
<ul>
<li>
<p>You can write your own (not common)</p>
</li>
<li>
<p>Must implement the <code>BeanPostProcessor</code> interface</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div id="config_lifecycle" class="imageblock">
<div class="content">
<img src="./img/config_lifecycle.png" alt="config lifecycle">
</div>
<div class="title">Figure 2. Configuration lifecycle.</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_use_phase"><a class="link" href="#_the_use_phase">6.3. The use phase</a></h3>
<div class="paragraph">
<p>When you invoke a bean obtained from the context the application is used. Beans get <strong>wrapped in  dynamic proxys</strong> which are created in the init phase by dedicated BeanPostProcessors. Spring will create two kinds of proxys: <strong>JDK</strong> and <strong>CGLib</strong> Proxies.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/proxies.png" alt="proxies">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JDK Proxy (Interface based)</dt>
<dd>
<p>(Recommended)</p>
<div class="ulist">
<ul>
<li>
<p>Also called dynamic proxies</p>
</li>
<li>
<p>API is built into the JDK</p>
</li>
<li>
<p>Requirements: Java interface(s)</p>
</li>
<li>
<p>All interfaces proxied</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">CGLib Proxy (Subclass based)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>NOT built into JDK</p>
</li>
<li>
<p>Included in Spring jars</p>
</li>
<li>
<p>Used when interface not available</p>
</li>
<li>
<p>Cannot be applied to final classes or methods</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_the_destruction_phase"><a class="link" href="#_the_destruction_phase">6.4. The destruction phase</a></h3>
<div class="paragraph">
<p>When you close a context the destruction phase completes. Bean instances get destroyed by invoking their clean-up/destroy methods if the JVM exits normally. After closing, the context itself will no longer be usable.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_spring_applications"><a class="link" href="#_testing_spring_applications">7. Testing Spring Applications</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Testing in General, Spring and JUnit, Profiles, Database Testing</p>
</div>
<div class="sect2">
<h3 id="_test_driven_development"><a class="link" href="#_test_driven_development">7.1. Test Driven Development</a></h3>
<div class="paragraph">
<p>TDD is about writing automated tests that verify code actually works and driving development with well defined requirements in the form of tests. Tested code allows faste and more confident refactoring &#8594; essential to agile development. If your code is hard to test then the design should be reconsidered.</p>
</div>
<div class="paragraph">
<p>The cost to fix a bug grows exponentially in proportion to the time before it is discovered.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unit_testing_without_spring"><a class="link" href="#_unit_testing_without_spring">7.2. Unit testing without Spring</a></h3>
<div class="ulist">
<ul>
<li>
<p>Tests one unit of functionality</p>
</li>
<li>
<p>Keeps dependencies minimal</p>
</li>
<li>
<p>Isolated from the environment (including Spring)</p>
</li>
<li>
<p>Uses simplified alternatives for dependencies</p>
<div class="ulist">
<ul>
<li>
<p>Stubs and/or Mocks</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_integration_testing_with_spring"><a class="link" href="#_integration_testing_with_spring">7.3. Integration Testing with Spring</a></h3>
<div class="paragraph">
<p>Integration testing <strong>tests the interaction of multiple units working together</strong>. All should work individually (unit tests showed this). They test application classes in <strong>context of their surrounding infrastructure</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Out-of-container testing, no need to run up full JEE system</p>
</li>
<li>
<p>Infrastructure may be “scaled down”</p>
<div class="ulist">
<ul>
<li>
<p>Use Apache DBCP connection pool instead of container- provider pool obtained through JNDI</p>
</li>
<li>
<p>Use ActiveMQ to save expensive commercial JMS licenses</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Production Mode Flow</div>
<ol class="arabic">
<li>
<p><strong>caller</strong> (Injected by Spring)</p>
</li>
<li>
<p><strong>TransferServiceImpl</strong> (Injected by Spring)</p>
</li>
<li>
<p><strong>JpaAccountRepo</strong></p>
</li>
<li>
<p><strong>Production DB</strong></p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Integration Test Flow</div>
<ol class="arabic">
<li>
<p><strong>TransferServiceTest</strong> (Injected by Spring)</p>
</li>
<li>
<p><strong>TransferServiceImpl</strong> (Injected by Spring)</p>
</li>
<li>
<p><strong>JpaAccountRepo</strong></p>
</li>
<li>
<p><strong>Test DB</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Spring&#8217;s integration test support comes packaged as a separate module <strong>spring-test.jar</strong>. It consists of several JUnit test support classes. The central support class is <code>SpringJUnit4ClassRunner</code> (caches a shared ApplicationContext across test methods). The <strong>ApplicationContext is instantiated only once</strong> for all tests that <strong>use the same set of config files</strong>.
(even across test classes)</p>
</div>
<div class="listingblock">
<div class="title">Spring JUnit runner example.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RunWith(SpringJUnit4ClassRunner.class) <b class="conum">(1)</b>
@ContextConfiguration(classes=SystemTestConfig.class) <b class="conum">(2)</b>
@ContextConfiguration(“classpath:com/acme/system-test-config.xml”) <b class="conum">(3)</b>
public final class TransferServiceTests {

	@Autowired <b class="conum">(4)</b>
	private TransferService transferService;

	@Test
	public void successfulTransfer(){
		TransferConfirmation conf = transferService.transfer(...); <b class="conum">(5)</b>
	}

	@Configuration <b class="conum">(6)</b>
	public static class TestConfiguration {
		@Bean public DataSource dataSource() { ... }
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Run with spring support.</p>
</li>
<li>
<p>Either point to config file (loads TransferServiceTests-context.xm if empty)&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203; or to XML config file.</p>
</li>
<li>
<p>Inject Bean to test.</p>
</li>
<li>
<p>Test the system as usual.</p>
</li>
<li>
<p>Alternative to specifying external classes. Must be <code>static</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Annotate test method with <code>@DirtiesContext</code> to force recreation of the cached ApplicationContext if method changes the contained beans.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Benefits of Testing with Spring</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>No need to deploy to an external container to test application functionality</p>
<div class="ulist">
<ul>
<li>
<p>Run everything quickly inside your IDE</p>
</li>
</ul>
</div>
</li>
<li>
<p>Allows reuse of your configuration between test and production environments</p>
<div class="ulist">
<ul>
<li>
<p>Application configuration logic is typically reused</p>
</li>
<li>
<p>Infrastructure configuration is environment-specific (DataSources, JMS Queues)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_testing_with_profiles"><a class="link" href="#_testing_with_profiles">7.4. Testing with Profiles</a></h3>
<div class="paragraph">
<p><strong>Aktivate one or more profiles</strong> with <code>@ActiveProfiles</code> inside the test class. Beans associated with that profile are instantiated. Also beans not associated with any profile. Works with Java config (with @Profile(&#8230;&#8203;) annotated @Configuration) and Annotations (with @Profile(&#8230;&#8203;) annotated @Component) and XML configuration (profile attribute in beans tag).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(classes=DevConfig.class)
@ActiveProfiles( { "jdbc", "dev" } )
public class TransferServiceTest {...}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_with_databases"><a class="link" href="#_testing_with_databases">7.5. Testing with Databases</a></h3>
<div class="paragraph">
<p>Integration testing against SQL database is common. <strong>In-memory databases</strong> useful for this kind of testing (no prior install). <strong>Populate DB</strong> before test runs with the <code>@Sql</code> annotation.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@Sql options</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>executionPhase</p>
<div class="ulist">
<ul>
<li>
<p>BEFORE_TEST_METHOD</p>
</li>
<li>
<p>AFTER_TEST_METHOD</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">@Sql config</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>errorMode</p>
<div class="ulist">
<ul>
<li>
<p><code>FAIL_ON_ERROR</code></p>
</li>
<li>
<p><code>CONTINUE_ON_ERROR</code></p>
</li>
<li>
<p><code>IGNORE_FAILED_DROPS</code></p>
</li>
<li>
<p><code>DEFAULT</code> (whatever @Sql defines at class level, otherwise FAIL_ON_ERROR)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">commentPrefix &amp; separator</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Syntax control</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(...)
@Sql({ “/testfiles/schema.sql”, “/testfiles/general-data.sql” } )  <b class="conum">(1)</b>
public final class MainTests {

	@Test
	@Sql <b class="conum">(2)</b>
	public void success(){...}

	@Test
	@Sql ( “/testfiles/error.sql” ) <b class="conum">(3)</b>
	@Sql ( scripts=“/testfiles/cleanup.sql”, <b class="conum">(4)</b>
			executionPhase=Sql.ExecutionPhase.AFTER_TEST_METHOD )
	public void transferError() {...}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Run these scripts before each @Test method.</p>
</li>
<li>
<p>Run script named (by default) MainTests.success.sql in same package.</p>
</li>
<li>
<p>Run before @Test method.</p>
</li>
<li>
<p>Run after @Test method.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_summary_4"><a class="link" href="#_summary_4">7.6. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Testing is an essential part of any development</p>
</li>
<li>
<p>Unit testing tests a class in isolation</p>
<div class="ulist">
<ul>
<li>
<p>External dependencies should be minimized</p>
</li>
<li>
<p>You don’t need Spring to unit test</p>
</li>
<li>
<p>Consider creating stubs or mocks to unit test</p>
</li>
</ul>
</div>
</li>
<li>
<p>Integration testing tests the interaction of multiple units working together</p>
<div class="ulist">
<ul>
<li>
<p>Spring provides good integration testing support</p>
</li>
<li>
<p>Profiles for different test &amp; deployment configurations</p>
</li>
<li>
<p>Built-in support for testing with Databases</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aspect_oriented_programming_aop"><a class="link" href="#_aspect_oriented_programming_aop">8. Aspect Oriented Programming (AOP)</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Using and Implementing Spring Proxies.</p>
</div>
<div class="sect2">
<h3 id="_what_problem_does_aop_solve"><a class="link" href="#_what_problem_does_aop_solve">8.1. What Problem Does AOP Solve?</a></h3>
<div class="paragraph">
<p>Aspect-Oriented Programming (AOP) enables <strong>modularization</strong> of <strong>cross-cutting concerns</strong>. An example requirement could be:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Perform a role-based security check before <strong>every</strong> application method.</p>
</div>
</blockquote>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cross-Cutting Concern</dt>
<dd>
<p>Generic functionality that is needed in many places in your application e.g.,
Logging and Tracing, Transaction Management, Security, Caching, Error Handling, Performance Monitoring, Custom Business Rules.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Failing to modularize cross-cutting concerns leads to two things: <strong>Code tangling</strong> (coupling of concerns) and <strong>Code scattering</strong> (the same concern spread across modules &#8658; code duplication).</p>
</div>
<div class="listingblock">
<div class="title">Tangling example.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class RewardNetworkImpl implements RewardNetwork {

	public RewardConfirmation rewardAccountFor(Dining dining) {
		if (!hasPermission(SecurityContext.getPrincipal()) {
			throw new AccessDeniedException(); <b class="conum">(1)</b>
		}

		Account a = accountRepository.findByCreditCard(...); <b class="conum">(1)</b>
	 	Restaurant r = restaurantRepository.findByMerchantNumber(...)
		MonetaryAmount amt = r.calculateBenefitFor(account, dining);
		...
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Mixed concerns.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/tangling_vs_scattering.png" alt="tangling vs scattering">
</div>
</div>
<div class="sect3">
<h4 id="_how_aop_works"><a class="link" href="#_how_aop_works">8.1.1. How AOP works</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Implement your mainline application logic</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Focusing on the core problem</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Write aspects to implement your cross-cutting concerns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring provides many aspects out-of-the-box</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Weave your aspects into the application</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Adding the cross-cutting behaviours to the right places</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_aspectj_vs_spring_aop"><a class="link" href="#_aspectj_vs_spring_aop">8.1.2. AspectJ vs. Spring AOP</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">AspectJ</dt>
<dd>
<p>A full-blown Aspect Oriented Programming language. Uses byte code modification for aspect weaving.</p>
</dd>
<dt class="hdlist1">Spring AOP</dt>
<dd>
<p>Java-based AOP framework with AspectJ integration. Uses dynamic proxies for aspect weaving. Focuses on using AOP to solve enterprise problems.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_core_aop_concepts"><a class="link" href="#_core_aop_concepts">8.2. Core AOP Concepts</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Join Point</dt>
<dd>
<p>A point in the execution of a program such as a method call or exception thrown.</p>
</dd>
<dt class="hdlist1">Pointcut</dt>
<dd>
<p>An expression that selects one or more Join Points.</p>
</dd>
<dt class="hdlist1">Advice</dt>
<dd>
<p>Code to be executed at each selected Join Point.</p>
</dd>
<dt class="hdlist1">Aspect</dt>
<dd>
<p>A module that encapsulates pointcuts and advice.</p>
</dd>
<dt class="hdlist1">Weaving</dt>
<dd>
<p>Technique by which aspects are combined with main code.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_quick_start"><a class="link" href="#_quick_start">8.3. Quick Start</a></h3>
<div class="paragraph">
<p>Lets consider this simple requirement:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Log a message every time a property is about to change.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">Define the aspect.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Aspect
@Component
public class PropertyChangeTracker {

	private Logger logger = Logger.getLogger(getClass());

	@Before(“execution(void set*(*))”)
	public void trackChange(JointPoint point) {  <b class="conum">(1)</b>
		String name = point.getSignature().getName();
		Object newValue = point.getArgs()[0];
		logger.info(name + “ about to change to ” + newValue + “ on ” + point.getTarget());
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Context information on the intercepted point.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Then configure the aspect as a Bean.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableAspectJAutoProxy <b class="conum">(1)</b>
@ComponentScan(basePackages=“com.example”)
public class AspectConfig {...}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configures Spring to apply @Aspect to you beans. XML: <code>&lt;aop:aspectj-autoproxy /&gt;</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Include aspect configuration.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@Import(AspectConfig.class) // here
public class MainConfig{

	@Bean
	public Cache cacheA() { return new SimpleCache(“cacheA”); }

	@Bean
	public Cache cacheB() { return new SimpleCache(“cacheB”); }

	@Bean
	public Cache cacheC() { return new SimpleCache(“cacheC”); }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">And then test it.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Autowired
@Qualifier(”cacheA”);
private Cache cache;
...
cache.setCacheSize(2500); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>INFO: setCacheSize about to change to 2500 on cacheA</code></p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/aspect_flow.png" alt="aspect flow">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_defining_pointcuts"><a class="link" href="#_defining_pointcuts">8.4. Defining Pointcuts</a></h3>
<div class="paragraph">
<p>Spring AOP uses a <strong>subset</strong> of AspectJ’s <a href="http://www.eclipse.org/aspectj/docs.php">pointcut expression language</a> for selecting where to apply advice.</p>
</div>
<div class="sect3">
<h4 id="_common_pointcut_designator"><a class="link" href="#_common_pointcut_designator">8.4.1. Common Pointcut Designator</a></h4>
<div class="ulist">
<ul>
<li>
<p>execution(&lt;method pattern&gt;)</p>
<div class="ulist">
<ul>
<li>
<p>The method must match the pattern</p>
</li>
</ul>
</div>
</li>
<li>
<p>Can chain together to create composite pointcuts</p>
<div class="ulist">
<ul>
<li>
<p>&amp;&amp; (and), || (or), ! (not)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Method Pattern</p>
<div class="ulist">
<ul>
<li>
<p><code>[Modifiers] ReturnType [ClassType] MethodName ([Arguments]) [throws ExceptionType]</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_examples"><a class="link" href="#_examples">8.4.2. Examples</a></h4>
<div class="imageblock">
<div class="content">
<img src="./img/pel_example1.png" alt="pel example1">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>execution(void send*(String))</code></dt>
<dd>
<p>Any method starting with send that takes a single String parameter and has a void return type.</p>
</dd>
<dt class="hdlist1"><code>execution(* send(*))</code></dt>
<dd>
<p>Any method named send that takes a single parameter</p>
</dd>
<dt class="hdlist1"><code>execution(* send(int, ..))</code></dt>
<dd>
<p>Any method named send whose first parameter is an int (the “..” signifies 0 or more parameters may follow)</p>
</dd>
<dt class="hdlist1"><code>execution(void example.MessageServiceImpl.*(..))</code></dt>
<dd>
<p>Any visible void method in the MessageServiceImpl class. Will fail if a different implementation is used</p>
</dd>
<dt class="hdlist1"><code>execution(void example.MessageService.send(*))</code></dt>
<dd>
<p>Any void send method taking one argument, in any object of type MessageService (including sub-classes or implementations of MessageService). More flexible choice – still works if implementation changes</p>
</dd>
<dt class="hdlist1"><code>execution(@javax.annotation.security.RolesAllowed void send*(..))</code></dt>
<dd>
<p>Any void method starting with send that is annotated with the @RolesAllowed annotation</p>
</dd>
<dt class="hdlist1"><code>execution(* rewards.*.restaurant.*.*(..))</code></dt>
<dd>
<p>There is one directory between rewards and restaurant</p>
</dd>
<dt class="hdlist1"><code>execution(* rewards..restaurant.<strong>.</strong>(..))</code></dt>
<dd>
<p>There may be several directories between rewards and restaurant</p>
</dd>
<dt class="hdlist1"><code>execution(* *..restaurant.*.*(..))</code></dt>
<dd>
<p>Any sub-package called restaurant</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_advice"><a class="link" href="#_implementing_advice">8.5. Implementing Advice</a></h3>
<div class="paragraph">
<p>There are different types of advices: @Before, @AfterReturning, @AfterThrowing, @After, and @Around.</p>
</div>
<div class="sect3">
<h4 id="__before"><a class="link" href="#__before">8.5.1. @Before</a></h4>
<div class="paragraph">
<p>Proxy &#8658; BeforeAdvice &#8658; Target</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Aspect
public class PropertyChangeTracker {

	private Logger logger = Logger.getLogger(getClass());

	@Before(“execution(void set*(*))”)
	public void trackChange() {
		logger.info(“Property about to change...”);
	}
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If the advice throws an exception, target will not be called.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__afterreturning"><a class="link" href="#__afterreturning">8.5.2. @AfterReturning</a></h4>
<div class="paragraph">
<p>Proxy &#8658; Target(success) &#8658; AfterAdvice</p>
</div>
<div class="listingblock">
<div class="title">Audit all operations in the service package that return a Reward object.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@AfterReturning(value=“execution(* service..*.*(..))”, returning=“reward”)
public void audit(JoinPoint jp, Reward reward) {
	auditService.logEvent(jp.getSignature() + “ returns the following reward object :” + reward.toString() );
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__afterthrowing"><a class="link" href="#__afterthrowing">8.5.3. @AfterThrowing</a></h4>
<div class="paragraph">
<p>Proxy &#8658; Target (exception thrown) &#8658; AfterThrowingAdvice</p>
</div>
<div class="listingblock">
<div class="title">Send an email every time a Repository class throws an exception of type DataAccessException.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@AfterThrowing(value=“execution(* *..Repository.*(..))”, throwing=“e”)
public void report(JoinPoint jp, DataAccessException e) {
	mailService.emailFailure(“Exception in repository”, jp, e);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The @AfterThrowing advice will not stop the exception from propagating but it can throw a <strong>different type of exception</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you wish to stop the exception from propagating any further, you can use an @Around advice.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__after"><a class="link" href="#__after">8.5.4. @After</a></h4>
<div class="paragraph">
<p>Proxy &#8658; Target (successful or exception) &#8658; AfterAdvice</p>
</div>
<div class="paragraph">
<p>Called regardless of whether an exception has been thrown by the target or not.</p>
</div>
<div class="listingblock">
<div class="title">Tracks calls to all update methods.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Aspect
public class PropertyChangeTracker {

	private Logger logger = Logger.getLogger(getClass());

	@After(“execution(void update*(..))”)
	public void trackUpdate() {
		logger.info(“An update has been attempted ...”);
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__around"><a class="link" href="#__around">8.5.5. @Around</a></h4>
<div class="paragraph">
<p>Proxy &#8658; AroundAdvice &#8658; Target &#8658; AroundAdvice</p>
</div>
<div class="paragraph">
<p>Provides a <code>ProceedingJoinPoint</code> parameter. Inherits from JoinPoint and adds the proceed() method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Around(“execution(@example.Cacheable * rewards.service..*.*(..))”)
public Object cache(ProceedingJoinPoint point) throws Throwable {

	Object value = cacheStore.get(cacheKey(point));

	if (value == null) { <b class="conum">(1)</b>
		value = point.proceed();
		cacheStore.put(cacheKey(point), value);
	}

	return value;</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Proceed only if not already cached.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_limitations"><a class="link" href="#_limitations">8.5.6. Limitations</a></h4>
<div class="ulist">
<ul>
<li>
<p>Can only advise non-private methods</p>
</li>
<li>
<p>Can only apply aspects to Spring Beans</p>
</li>
<li>
<p>Limitations of weaving with proxies</p>
<div class="ulist">
<ul>
<li>
<p>When using proxies, suppose method a() calls method b() on the same class/interface</p>
<div class="ulist">
<ul>
<li>
<p>advice will never be executed for method b()</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_summary_5"><a class="link" href="#_summary_5">8.5.7. Summary</a></h4>
<div class="ulist">
<ul>
<li>
<p>Aspect Oriented Programming (AOP) modularizes cross-cutting concerns.</p>
</li>
<li>
<p>An aspect is a module containing cross-cutting behavior.</p>
<div class="ulist">
<ul>
<li>
<p>Behavior is implemented as “advice”</p>
</li>
<li>
<p>Pointcuts select where advice applies</p>
</li>
<li>
<p>Five advice types: Before, AfterThrowing, AfterReturning, After and Around</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_access"><a class="link" href="#_data_access">9. Data Access</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Implementing Data Access and Caching.</p>
</div>
<div class="sect2">
<h3 id="_the_role_of_spring_in_enterprise_data_access"><a class="link" href="#_the_role_of_spring_in_enterprise_data_access">9.1. The Role of Spring in Enterprise Data Access</a></h3>
<div class="paragraph">
<p>Works consistently with leading data access technologies. Resource management usually requires access (establishing or closing a connection) or transaction management. Spring manages this with <strong>no additional code</strong>, <strong>prevents session leakage</strong>, and <strong>throws own exceptions</strong>, independent from the underlying api. Transaction management can be done in a simple, declarative way.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Template Design Pattern <a href="http://en.wikipedia.org/wiki/Template_method_pattern">link</a></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Define the outline or skeleton of an algorithm</p>
<div class="ulist">
<ul>
<li>
<p>Leave the details to specific implementations later</p>
</li>
<li>
<p>Hides away large amounts of boilerplate code</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring provides many template classes</p>
<div class="ulist">
<ul>
<li>
<p>JdbcTemplate</p>
</li>
<li>
<p>JmsTemplate</p>
</li>
<li>
<p>RestTemplate</p>
</li>
<li>
<p>WebServiceTemplate</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_declarative_transaction_management"><a class="link" href="#_declarative_transaction_management">9.1.1. Declarative Transaction Management</a></h4>
<div class="paragraph">
<p>Every thread needs its own transaction. Spring&#8217;s transaction manager handles these within the <strong>thread-local storage</strong>. Data-access code, like JdbcTemplate, finds it automatically or do it yourself: <code>DataSourceUtils.getConnection(dataSource)</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/trx_management.png" alt="trx management">
</div>
</div>
<div class="paragraph">
<p>Many enterprise applications consist of three logical layers.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Service Layer (or application layer)</dt>
<dd>
<p>Exposes high-level application functions. Use-cases and business logic is defined here.</p>
</dd>
<dt class="hdlist1">Data access Layer</dt>
<dd>
<p>Defines interface to the application’s data repository (such as a Relational or NoSQL database).</p>
</dd>
<dt class="hdlist1">Infrastructure Layer</dt>
<dd>
<p>Exposes low-level services to the other layers.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_s_dataaccessexceptionhierarchy"><a class="link" href="#_spring_s_dataaccessexceptionhierarchy">9.2. Spring&#8217;s DataAccessExceptionHierarchy</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Checked Exceptions</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Force developers to handle errors. But if you can&#8217;t handle it, must declare it.</p>
</li>
<li>
<p><strong>Bad</strong>: Intermediate methods must declare exception(s) from all methods below (form of tight-coupling).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Unchecked Exceptions</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Can be thrown up the call hierarchy to the best place to handle it.</p>
</li>
<li>
<p><strong>Good</strong>: Methods in between don&#8217;t know about it.</p>
<div class="ulist">
<ul>
<li>
<p>BetterinanEnterpriseApplication</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring throws Runtime (unchecked) Exceptions</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>SQLExceptions</strong> are <strong>too general</strong>. There is only one exception for every database error. Calling class 'knows' you are using JDBC (tight coupling). Spring provides the <code>DataAccessException</code> hierarchy. It <strong>hides</strong> whether you are using JPA or anything else and provides several <strong>unchecked</strong> exceptions which are consistent between different technologies.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/data_access_ex_hierarchy.png" alt="data access ex hierarchy">
</div>
<div class="title">Figure 3. Spring Data Access Exceptions.</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_test_databases"><a class="link" href="#_using_test_databases">9.3. Using Test Databases</a></h3>
<div class="paragraph">
<p>Spring provides an <strong>Embedded Database Builder</strong> to conveniently define a new <strong>(empty) in-memory database</strong>. HSQL, H2 and Derby are supported.</p>
</div>
<div class="listingblock">
<div class="title">In java&#8230;&#8203;</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public DataSource dataSource() {

	EmbeddedDatabaseBuilder builder = new EmbeddedDatabaseBuilder();
	return builder.setName("testdb")
			.addScript("classpath:/testdb/schema.db")
			.addScript("classpath:/testdb/test-data.db").build();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">and xml possible.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;bean class=“example.order.JdbcOrderRepository” &gt;
	&lt;property name=“dataSource” ref=“dataSource” /&gt;
&lt;/bean&gt;

&lt;jdbc:embedded-database id=“dataSource” type=“H2”&gt;
	&lt;jdbc:script location=“classpath:schema.sql” /&gt;
	&lt;jdbc:script location=“classpath:test-data.sql” /&gt;
&lt;/jdbc:embedded-database&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Also allows populating other (existing) data sources.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;bean id=“dataSource” class=“org.apache.commons.dbcp.BasicDataSource”&gt;
	&lt;property name=“url” value=“${dataSource.url}” /&gt;
	&lt;property name=“username” value=“${dataSource.username}” /&gt;
	&lt;property name=“password” value=“${dataSource.password}” /&gt;
&lt;/bean&gt;

&lt;jdbc:initialize-database data-source=“dataSource”&gt;
	&lt;jdbc:script location=“classpath:schema.sql” /&gt; <b class="conum">(1)</b>
	&lt;jdbc:script location=“classpath:test-data.sql” /&gt;
&lt;/jdbc:initialize-database&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initializes an external database.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Also in java.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class DatabaseInitializer {
	@Value("classpath:schema.sql")
	private Resource schemaScript;

	@Value("classpath:test-data.sql")
	private Resource dataScript;

	private DatabasePopulator databasePopulator() {
		final ResourceDatabasePopulator populator = new ResourceDatabasePopulator();
		populator.addScript(schemaScript);
		populator.addScript(dataScript);
		return populator;
	}

	@Bean
	public DataSourceInitializer anyName(final DataSource dataSource) {
		final DataSourceInitializer initializer = new DataSourceInitializer();
		initializer.setDataSource(dataSource);
		initializer.setDatabasePopulator(databasePopulator()); <b class="conum">(1)</b>
		return initializer;
	}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Explicitly create a database initializer which will do the work in its post-construct method.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_caching"><a class="link" href="#_implementing_caching">9.4. Implementing Caching</a></h3>
<div class="paragraph">
<p>A cache is a key-value store (map) and can be applied to methods often returning the same value for equal inputs. A unique key (cache key) must be generated from the arguments.</p>
</div>
<div class="paragraph">
<p>Spring transparently applies caching to Spring beans (AOP). Just mark methods <code>@Cacheable</code>, provide a  caching key(s) and the name of cache to use (multiple caches supported, define in spring config). Enable caching via. <code>@EnableCaching</code> or <code>&lt;cache:annotation-driven /&gt;</code>. You will also have to <strong>specify a cache-manager</strong> (some provided in <code>org.springframework.cache</code>). Consider 3rd party cache-managers like ehCache or Gemfire.</p>
</div>
<div class="listingblock">
<div class="title">In-memory cache.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Cacheable
public Country[] loadAllCountries() { ... }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementing a custom cache-manager: a concurrent map cache.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public CacheManager cacheManager() {
	SimpleCacheManager cmgr = new SimpleCacheManager();
	Set&lt;Cache&gt; caches = new HashSet&lt;Cache&gt;();
	caches.add(new ConcurrentMapCache("topAuthors"));
	caches.add(new ConcurrentMapCache("topBooks"));
	cmgr.setCaches(caches);
	return cmgr;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Cacheable</code> marks a method for caching its result is stored in a cache. Subsequent invocations (with the same arguments) fetch data from cache using key (method not executed).The <code>key</code> for each cached data-item uses SpEL and argument(s) of method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class BookService {

	@Cacheable(value="topBooks", key="#title", condition="#title.length &lt; 32") <b class="conum">(1)</b>
	public Book findBook(String title, boolean checkWarehouse) { ... }

	@Cacheable(value="topBooks", key="#author.name") <b class="conum">(2)</b>
	public Book findBook2(Author author, boolean checkWarehouse) { ... }

	@Cacheable(value="topBooks", key="T(example.KeyGen).hash(#author)") <b class="conum">(3)</b>
	public Book findBook3(Author author, boolean checkWarehouse) { ... }

	@CacheEvict(value="topBooks") <b class="conum">(4)</b>
	public void loadBooks() { ... }

	...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Only cache if condition true.</p>
</li>
<li>
<p>Use object property.</p>
</li>
<li>
<p>Custom key generator.</p>
</li>
<li>
<p>Clear cache before method invoked.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_nosql_databases"><a class="link" href="#_nosql_databases">9.5. NoSQL databases</a></h3>
<div class="paragraph">
<p>Spring does not only support SQL databases. It supports many more such as document-based, graph-based, big-data and column stores.</p>
</div>
</div>
<div class="sect2">
<h3 id="_summary_6"><a class="link" href="#_summary_6">9.6. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Enables layered architecture principles</p>
<div class="ulist">
<ul>
<li>
<p>Higher layers should not know about data management below</p>
</li>
</ul>
</div>
</li>
<li>
<p>Isolate via Data Access Exceptions</p>
<div class="ulist">
<ul>
<li>
<p>Hierarchy makes them easier to handle</p>
</li>
</ul>
</div>
</li>
<li>
<p>Provides consistent transaction management</p>
<div class="ulist">
<ul>
<li>
<p>Supports most leading data-access technologies Relational and non-relational (NoSQL)</p>
</li>
</ul>
</div>
</li>
<li>
<p>A key component of the core Spring libraries</p>
</li>
<li>
<p>Automatic caching facility</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jdbc"><a class="link" href="#_jdbc">10. JDBC</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Using the JDBC Template.</p>
</div>
<div class="sect2">
<h3 id="_problems_with_traditional_jdbc"><a class="link" href="#_problems_with_traditional_jdbc">10.1. Problems with traditional JDBC</a></h3>
<div class="paragraph">
<p>Traditional JDBC means <strong>redundant, error prone</strong> code with <strong>poor exception handling</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_spring_s_jdbctemplate"><a class="link" href="#_spring_s_jdbctemplate">10.2. Spring’s JdbcTemplate</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">JDBC Template Responsibilities</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Acquisition/release of the connection</p>
</li>
<li>
<p>Transaction management</p>
</li>
<li>
<p>Execution of the statement</p>
</li>
<li>
<p>Processing of the result set</p>
</li>
<li>
<p>Handling any exceptions</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Greatly simplifies use of the JDBC API. Eliminates repetitive boilerplate code, hence alleviating a common causes of bugs. It also handles SQLExceptions properly without sacrificing power. It provides full access to the standard JDBC constructs.</p>
</div>
<div class="paragraph">
<p>Creating a JdbcTemplate requires a <strong>datasource</strong>. Once instantiated, <strong>reuse</strong> it. It can query <strong>simple types, generic maps and domain objects</strong>.</p>
</div>
<div class="listingblock">
<div class="title">JDBC template example.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class JdbcCustomerRepository implements CustomerRepository {

	private JdbcTemplate jdbcTemplate;

	public JdbcCustomerRepository(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate(dataSource);
	}

	public int getCustomerCount() {
		String sql = “select count(*) from customer”;
		return jdbcTemplate.queryForObject(sql, Integer.class); <b class="conum">(1)</b>
	}

	public int getCountOfNationalsOver(Nationality nationality, int age) {
		String sql = “select count(*) from PERSON ” +
				“where age &gt; ? and nationality = ?”;
		return jdbcTemplate.queryForObject(sql, Integer.class, age, nationality.toString()); <b class="conum">(2)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Throws unchecked exceptions only.</p>
</li>
<li>
<p>Bind variables.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_query_execution"><a class="link" href="#_query_execution">10.3. Query Execution</a></h3>
<div class="sect3">
<h4 id="_generic_queries"><a class="link" href="#_generic_queries">10.3.1. Generic Queries</a></h4>
<div class="paragraph">
<p>JdbcTemplate returns each row of a ResultSet as a Map. When expecting a single row, use <code>queryForMap(..)</code>. Use <code>queryForList(..)</code> for multiple rows. The data fetched does not need mapping to a Java object. Be careful with very large data-sets.</p>
</div>
</div>
<div class="sect3">
<h4 id="_querying_generic_maps"><a class="link" href="#_querying_generic_maps">10.3.2. Querying Generic Maps</a></h4>
<div class="listingblock">
<div class="title">Query for a single row. Returns a map of <em>column name|value</em> pairs.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public Map&lt;String,Object&gt; getPersonInfo(int id) {
	String sql = “select * from PERSON where id=?”;
	return jdbcTemplate.queryForMap(sql, id);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query for multiple rows. Returns a list of maps of <em>column name|value</em> pairs.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public Map&lt;String,Object&gt; getPersonInfo(int id) {
	String sql = “select * from PERSON where id=?”;
	return jdbcTemplate.queryForMap(sql, id);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_querying_domain_objects"><a class="link" href="#_querying_domain_objects">10.3.3. Querying Domain Objects</a></h4>
<div class="paragraph">
<p>Spring allows mapping relational data into domain objects e.g., a ResultSet to an Account using a callback approach. You may prefer to use ORM for this (JdbcTemplate vs. JPA or similar mappings). Some tables may be too hard to map with JPA.</p>
</div>
</div>
<div class="sect3">
<h4 id="_working_with_result_sets"><a class="link" href="#_working_with_result_sets">10.3.4. Working with result sets</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">RowMapper</dt>
<dd>
<p>Maps a single row of a ResultSet to an object and can be used for single- and multiple- row queries.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public Person getPerson(int id) {
	return jdbcTemplate.queryForObject(“select first_name,
			last_name from PERSON where id=?”,
			new PersonMapper(),
			id);
}

...

class PersonMapper implements RowMapper&lt;Person&gt; {
	public Person mapRow(ResultSet rs, int rowNum) throws SQLException {
		return new Person(rs.getString("first_name"),
				rs.getString("last_name"));
	}
}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">RowCallbackHandler</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring provides a simpler RowCallbackHandler interface when there is no return object</p>
<div class="ulist">
<ul>
<li>
<p>Streaming rows to a file</p>
</li>
<li>
<p>Converting rows to XML</p>
</li>
<li>
<p>Filtering rows before adding to a Collection (filtering in SQL is much more efficient)</p>
</li>
<li>
<p>Faster than JPA equivalent for big queries (avoids result-set to object mapping)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class JdbcOrderRepository {

	public void generateReport(Writer out) {
		// select all orders of year 2009 for a full report
		jdbcTemplate.query(“select * from order where year=?”,
				new OrderReportWriter(out), 2009);
	}
}

class OrderReportWriter implements RowCallbackHandler {

	public void processRow(ResultSet rs) throws SQLException {
		// parse current row from ResultSet and stream to output
	}
}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ResultSetExtractor</dt>
<dd>
<p>Spring provides a ResultSetExtractor interface for processing an entire ResultSet at once. You are responsible for iterating the ResultSet. Useful e.g. for mapping entire ResultSet to a single object.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class JdbcOrderRepository {

	public Order findByConfirmationNumber(String number) {
		// execute an outer join between order and item tables
		return jdbcTemplate.query(“select...from order o, item i...conf_id = ?”,
				new OrderExtractor(), number);
	}
}

class OrderExtractor implements ResultSetExtractor&lt;Order&gt; {

	public Order extractData(ResultSet rs) throws SQLException {
		Order order = null;
		while (rs.next()) {
			if (order == null) {
				order = new Order(rs.getLong("ID"), rs.getString("NAME"), ...);
			}
			order.addItem(mapItem(rs));
		}
		return order;
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_summary_of_callback_interfaces"><a class="link" href="#_summary_of_callback_interfaces">10.3.5. Summary of Callback Interfaces</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">RowMapper</dt>
<dd>
<p>Best choice when each row of a ResultSet maps to a domain object.</p>
</dd>
<dt class="hdlist1">RowCallbackHandler</dt>
<dd>
<p>Best choice when no value should be returned from the callback method for each row.</p>
</dd>
<dt class="hdlist1">ResultSetExtractor</dt>
<dd>
<p>Best choice when multiple rows of a ResultSet map to a single object.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inserts_and_updates"><a class="link" href="#_inserts_and_updates">10.4. Inserts and Updates</a></h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public int insertPerson(Person person) {
	return jdbcTemplate.update( <b class="conum">(1)</b>
			“insert into PERSON (first_name, last_name, age) values (?, ?, ?)”,
			person.getFirstName(),
			person.getLastName(),
			person.getAge();
}

public int updateAge(Person person) {
	return jdbcTemplate.update(
			“update PERSON set age=? where id=?”,
			person.getAge(),
			person.getId());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Update method returns number of rows modified.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_exception_handling"><a class="link" href="#_exception_handling">10.5. Exception handling</a></h3>
<div class="paragraph">
<p>The JdbcTemplate transforms SQLExceptions into <code>DataAccessExceptions</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transactions"><a class="link" href="#_transactions">11. Transactions</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Transactional proxies and @Transactional.</p>
</div>
<div class="sect2">
<h3 id="_why_use_transactions"><a class="link" href="#_why_use_transactions">11.1. Why use Transactions?</a></h3>
<div class="paragraph">
<p>A set of tasks which take place as a single, indivisible action. It follows the <strong>ACID</strong> principles.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Atomic</dt>
<dd>
<p>Each unit of work is an all-or-nothing operation.</p>
</dd>
<dt class="hdlist1">Consistent</dt>
<dd>
<p>Database integrity constraints are never violated.</p>
</dd>
<dt class="hdlist1">Isolated</dt>
<dd>
<p>Isolating transactions from each other.</p>
</dd>
<dt class="hdlist1">Durable</dt>
<dd>
<p>Committed changes are permanent.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_java_transaction_management"><a class="link" href="#_java_transaction_management">11.2. Java Transaction Management</a></h3>
<div class="paragraph">
<p>Java has several APIs which <strong>handle transactions differently</strong>: JDBC, JMS, JTA, Hibernate, JPA, etc. Each uses <strong>program code to mark the start and end of the transaction</strong> (Transaction Demarcation) where there are different APIs for <strong>Global vs Local transactions</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Local Transactions</dt>
<dd>
<p>Transactions managed by underlying resource.<br>
App &#8658; Database</p>
</dd>
<dt class="hdlist1">Global (distributed) Transactions</dt>
<dd>
<p>Transaction managed by separate, dedicated transaction manager.<br>
App &#8658; TRX manager &#8658; PSQL, RabbitMQ, &#8230;&#8203;</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_drawbacks"><a class="link" href="#_drawbacks">11.2.1. Drawbacks</a></h4>
<div class="ulist">
<ul>
<li>
<p>Multiple APIs for different local resources</p>
</li>
<li>
<p>Programatic transaction demarcation</p>
<div class="ulist">
<ul>
<li>
<p>Typically performed in the repository layer (wrong place)</p>
</li>
<li>
<p>Usually repeated (cross-cutting concern)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Service layer more appropriate</p>
<div class="ulist">
<ul>
<li>
<p>Multiple data access methods often called within a single transaction</p>
</li>
<li>
<p>But: don&#8217;t want data-access code in service-layer Orthogonal concerns</p>
</li>
</ul>
</div>
</li>
<li>
<p>Transaction demarcation should be independent of transaction implementation</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Transactions which are already in progress cannot be joined and code cannot be used with global transactions.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java"> try {
	conn = dataSource.getConnection(); <b class="conum">(1)</b>
	conn.setAutoCommit(false); <b class="conum">(2)</b>
	...
	conn.commit(); <b class="conum">(2)</b>
} catch (Exception e) { <b class="conum">(3)</b>
	conn.rollback();
	...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specific to JDBC API.</p>
</li>
<li>
<p>Programatic trx demarcation.</p>
</li>
<li>
<p>Checked exceptions.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_transaction_management"><a class="link" href="#_spring_transaction_management">11.3. Spring Transaction Management</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring separates transaction demarcation from transaction implementation</p>
<div class="ulist">
<ul>
<li>
<p>Demarcation expressed declaratively via AOP</p>
<div class="ulist">
<ul>
<li>
<p>Programatic approach also available</p>
</li>
</ul>
</div>
</li>
<li>
<p>PlatformTransactionManager abstraction hides implementation details.</p>
<div class="ulist">
<ul>
<li>
<p>Several implementations available</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Spring uses the same API for global vs. local.</p>
<div class="ulist">
<ul>
<li>
<p>Change from local to global is minor</p>
<div class="ulist">
<ul>
<li>
<p>Just change the transaction manager</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are 2 steps: declare a <code>PlatformTransactionManager</code> bean and the transactional methods (annotationm, XML or programatic).</p>
</div>
<div class="sect3">
<h4 id="_platformtransactionmanager"><a class="link" href="#_platformtransactionmanager">11.3.1. PlatformTransactionManager</a></h4>
<div class="paragraph">
<p>Spring’s <code>PlatformTransactionManager</code> is the base interface for the abstraction. Several implementations are available e.g., DataSourceTransactionManager, HibernateTransactionManager and more.</p>
</div>
<div class="listingblock">
<div class="title">Manager for a datasource.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public PlatformTransactionManager transactionManager(DataSource dataSource) {
	return new DataSourceTransactionManager(dataSource);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">In the code.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class RewardNetworkImpl implements RewardNetwork {

	@Transactional
	public RewardConfirmation rewardAccountFor(Dining d) {
		// atomic unit-of-work
	}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">In the configuration.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableTransactionManagement <b class="conum">(1)</b>
public class TxnConfig {

	@Bean
	public PlatformTransactionManager transactionManager(DataSource ds){
		return new DataSourceTransactionManager(ds);
	}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Defines a Bean Post-Processor.</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">What happens</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Target object wrapped in a proxy (Around advice)</p>
</li>
<li>
<p>Proxy implements the following behavior</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Transaction started before entering the method</p>
</li>
<li>
<p>Commit at the end of the method</p>
</li>
<li>
<p>Rollback if method throws a RuntimeException (default, can be overridden)</p>
</li>
</ol>
</div>
</li>
<li>
<p>Transaction context bound to current thread.</p>
</li>
<li>
<p>All controlled by configuration</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="__transactional"><a class="link" href="#__transactional">11.3.2. @Transactional</a></h4>
<div class="paragraph">
<p>On class the @Transactional applies to all methods declared in the interface(s). You can also declare it on both, class- and method- level but with different settings e.g., timeouts.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_isolation_levels"><a class="link" href="#_isolation_levels">11.4. Isolation Levels</a></h3>
<div class="paragraph">
<p>There are 4 isolation levels where some DBMS may not support all levels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Transactional (isolation=Isolation.XXX)</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">READ_UNCOMMITTED</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Lowest level - allows dirty reads</p>
</li>
<li>
<p>Current transaction can see the results of another uncommitted unit-of-work</p>
</li>
<li>
<p>Typically used for large, intrusive read-only transactions</p>
</li>
<li>
<p>And/or where the data is constantly changing</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">READ_COMMITTED</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Does not allow dirty reads (only committed information can be accessed)</p>
</li>
<li>
<p>Default strategy for most databases</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">REPEATABLE_READ</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Does not allow dirty reads</p>
</li>
<li>
<p>Non-repeatable reads are prevented</p>
<div class="ulist">
<ul>
<li>
<p>If a row is read twice in the same transaction, result will always be the same</p>
</li>
<li>
<p>Might result in locking depending on the DBMS</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">SERIALIZABLE</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Prevents non-repeatable reads and dirty-reads</p>
</li>
<li>
<p>Also prevents phantom reads</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_transaction_propagation"><a class="link" href="#_transaction_propagation">11.5. Transaction Propagation</a></h3>
<div class="paragraph">
<p>Transaction propagation is calling a <code>@Transactional</code> method within another <code>@Transactional</code> method. There are <strong>7 levels of propagation</strong>. Two will be presented here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Transactional( propagation=Propagation.XXX )</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">REQUIRED</dt>
<dd>
<p>Default. Execute within a current transaction, create a new one if none existing.</p>
</dd>
<dt class="hdlist1">REQUIRES_NEW</dt>
<dd>
<p>Create a new transaction, suspending the current transaction of one exists.</p>
</dd>
<dt class="hdlist1">MANDATORY</dt>
<dd>
<p>Throw exception if none exists; otherwise use current transaction.</p>
</dd>
<dt class="hdlist1">NEVER</dt>
<dd>
<p>Don&#8217;t create a transaction if none exists. Throw exception if one existing.</p>
</dd>
<dt class="hdlist1">NOT_SUPPORTED</dt>
<dd>
<p>Don&#8217;t create a transaction if none exists. Suspend transaction, if one exists, then run method outside of a transaction.</p>
</dd>
<dt class="hdlist1">SUPPORTS</dt>
<dd>
<p>Don&#8217;t create a transaction if none exists; otherwise use existing transaction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_rollback_rules"><a class="link" href="#_rollback_rules">11.6. Rollback rules</a></h3>
<div class="paragraph">
<p>By default, a transaction is rolled back if a RuntimeException has been thrown. Default settings can be overridden with <code>rollbackFor</code> and <code>noRollbackFor</code> attributes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Transactional(rollbackFor=MyCheckedException.class, noRollbackFor={JmxException.class, MailException.class})</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing"><a class="link" href="#_testing">11.7. Testing</a></h3>
<div class="paragraph">
<p>Annotate test method (or class) with <code>@Transactional</code>. This runs the test method in a transaction and <strong>rolls back afterwards</strong>. Using the <code>@Commit</code> annotation, the transaction won&#8217;t be rolled back. Test methods with <code>@BeforeTransaction</code> get executed before the transaction is created.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_object_relational_mapping_orm"><a class="link" href="#_object_relational_mapping_orm">12. Object Relational Mapping (ORM)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java_persistence_api_jpa"><a class="link" href="#_java_persistence_api_jpa">13. Java Persistence API (JPA)</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Object Relational Mapping with Spring &amp; Java Persistence API.</p>
</div>
<div class="sect2">
<h3 id="_introduction_to_jpa"><a class="link" href="#_introduction_to_jpa">13.1. Introduction to JPA</a></h3>
<div class="paragraph">
<p>The Java Persistence API is designed for operating on domain objects: <strong>Pojos, no interfaces</strong>. It is a common API for object-relational mapping.</p>
</div>
<div class="sect3">
<h4 id="_general_concepts"><a class="link" href="#_general_concepts">13.1.1. General Concepts</a></h4>
<div class="paragraph">
<p>The key concepts comprise the Entity Manager, Entity Manager Factory and the Persistence Context.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">EntityManager</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Manages a unit of work and persistent objects therein: the <code>PersistenceContext</code>.</p>
</li>
<li>
<p>Lifecycle often bound to a Transaction (usually container- managed).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">persist(Object o); // SQL: insert into table ... <b class="conum">(1)</b>
remove(Object o); // SQL: delete from table ... <b class="conum">(2)</b>
find(Class entity, Object primaryKey); // SQL: select * from table where id = ? <b class="conum">(3)</b>
Query createQuery(String jpqlString); <b class="conum">(4)</b>
flush(); <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Adds the entity to the Persistence Context.</p>
</li>
<li>
<p>Removes the entity from the Persistence Context.</p>
</li>
<li>
<p>Find by primary key.</p>
</li>
<li>
<p>Create a JPQL query.</p>
</li>
<li>
<p>Force changed entity state to be written to database immediately.</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">EntityManagerFactory</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>thread-safe, shareable object that represents a single data source / persistence unit.</p>
</li>
<li>
<p>Provides access to new application-managed EntityManagers.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Persistence Unit</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Describes a group of persistent classes (entities)</p>
</li>
<li>
<p>Defines provider(s)</p>
</li>
<li>
<p>Defines transactional types (local vs JTA)</p>
</li>
<li>
<p>Multiple Units per application are allowed</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The configuration can be in the Persistence Unit in the Spring bean-file or a combination of the two.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/jpa_overview.png" alt="jpa overview">
</div>
<div class="title">Figure 4. Persistence Context and EntityManager.</div>
</div>
</div>
<div class="sect3">
<h4 id="_mapping"><a class="link" href="#_mapping">13.1.2. Mapping</a></h4>
<div class="paragraph">
<p>JPA requires metadata for mapping classes/fields to database tables/columns, usually provided as <strong>annotations</strong> (XML mappings also supported for overrides). JPA metadata relies on defaults &#8594; do not specify the obvious. Annotate classes (table), fields (column, persistent by default vs. transient) or getters (also columns).</p>
</div>
<div class="paragraph">
<p>Common relationship mappings e.g., single and collection of entities are supported. <strong>Associations can be uni- or bi-directional</strong>.  You can also <strong>map a row to multiple classes</strong> with <code>@AttributeOverride(&#8230;&#8203;)</code>.</p>
</div>
<div class="listingblock">
<div class="title">Mapping using fields. <code>@Entity</code> and <code>@Id</code> are mandatory.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Entity <b class="conum">(1)</b>
@Table(name= “T_CUSTOMER”) <b class="conum">(1)</b>
public class Customer {

	@Id <b class="conum">(2)</b>
	@Column(name=“cust_id”) <b class="conum">(3)</b>
	private Long id;

	@Column(name=“first_name”) <b class="conum">(3)</b>
	private String firstName;

	@Transient <b class="conum">(4)</b>
	private User currentUser;

	@OneToMany
	@JoinColumn (name=“cid”) <b class="conum">(5)</b>
	private Set&lt;Address&gt; addresses;

	@Embedded
	@AttributeOverride (name="postcode", column=@Column(name="ZIP")) <b class="conum">(6)</b>
	private Address office;
	...
}

@Embeddable
public class Address {
	private String street;
	private String suburb;
	private String city;
	private String postcode; <b class="conum">(6)</b>
	private String country;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Mark as an entity Optionally override table name.</p>
</li>
<li>
<p>Mark id-field (primary key).</p>
</li>
<li>
<p>Optionally override column names.</p>
</li>
<li>
<p>Not stored in database.</p>
</li>
<li>
<p>Foreig key in Address table.</p>
</li>
<li>
<p>Maps to "ZIP" column in "T_CUSTOMER".</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Mapping using accessors.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Entity @Table(name= “T_CUSTOMER”)
public class Customer {
	private Long id;
	private String firstName;

	@Id <b class="conum">(1)</b>
	@Column (name=“cust_id”)
	public Long getId() { return this.id; }

	@Column (name=“first_name”) <b class="conum">(2)</b>
 	String getFirstName() { return this.firstName; }

	public void setFirstName(String fn) { this.firstName = fn; }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Must place <code>@Id</code> on the getter.</p>
</li>
<li>
<p>Other annotations also place on getter methods.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_querying"><a class="link" href="#_querying">13.1.3. Querying</a></h4>
<div class="ulist">
<ul>
<li>
<p>Retrieve an object <strong>by primary key</strong>.</p>
</li>
<li>
<p>Query for objects using <strong>JPA Query Language (JPQL)</strong>.</p>
<div class="ulist">
<ul>
<li>
<p>Similar to SQL and HQL.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Query for objects using <strong>Criteria Queries</strong>.</p>
<div class="ulist">
<ul>
<li>
<p>API for creating ad hoc queries.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Execute <strong>SQL directly</strong> to underlying database.</p>
<div class="ulist">
<ul>
<li>
<p>“Native” queries, allow DBMS-specific SQL to be used.</p>
</li>
<li>
<p>Consider JdbcTemplate instead when not using managed objects – more options/control, more efficient.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Querying by Primary Key</dt>
<dd>
<p>To retrieve an object by its database identifier simply call find() on the EntityManager. Returns null if no object exists.</p>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Querying with JPQL</dt>
<dd>
<p>Query for objects with <code>SELECT</code> based on properties or associations (cannot use <code>*</code>).</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// Query with named parameters
TypedQuery&lt;Customer&gt; query = entityManager.createQuery(
		“select c from Customer c where c.address.city = :city”,
		Customer.class); query.setParameter(“city”, “Chicago”);
List&lt;Customer&gt; customers = query.getResultList();

// ... or using a single statement
List&lt;Customer&gt; customers2 = entityManager.createQuery(“select c from Customer c ...”, Customer.class)
		.setParameter(“city”, “Chicago”)
		.getResultList();

// ... or if expecting a single result
Customer customer = query.getSingleResult();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_jpa_in_spring"><a class="link" href="#_configuring_jpa_in_spring">13.2. Configuring JPA in Spring</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Steps to using JPA with Spring</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define an EntityManagerFactory bean.</p>
</li>
<li>
<p>Define a DataSource bean</p>
</li>
<li>
<p>Define a Transaction Manager bean</p>
</li>
<li>
<p>Define Mapping Metadata</p>
</li>
<li>
<p>Define DAOs</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Beean
public LocalContainerEntityManagerFactoryBean entityManagerFactory(){

	HibernateJpaVendorAdapter adapter = new HibernateJpaVendorAdapter();
	adapter.setShowSql(true);
	adapter.setGenerateDdl(true);
	adapter.setDatabase(Database.HSQL);

	Properties props = new Properties();
	props.setProperty("hibernate.format_sql", "true");

	LocalContainerEntityManagerFactoryBean emfb = new LocalContainerEntityManagerFactoryBean();
	emfb.setDataSource(dataSource);
	emfb.setPackagesToScan("rewards.internal");
	emfb.setJpaProperties(props); emfb.setJpaVendorAdapter(adapter);
	return emfb;
}

@Bean
public PlatformTransactionManager transactionManager(EntityManagerFactory emf) {
	return new JpaTransactionManager(emf);
}

@Bean
public DataSource dataSource() { // Lookup via JNDI or create locally. }</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/jpa_config.png" alt="jpa config">
</div>
<div class="title">Figure 5. EntityManagerFactoryBean Configuration.</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_jpa_daos"><a class="link" href="#_implementing_jpa_daos">13.3. Implementing JPA DAOs</a></h3>
<div class="paragraph">
<p>JPA provides configuration options so Spring can manage transactions and the EntityManager. There are <strong>no Spring dependencies in your DAO</strong> implementations. Optional: Use AOP for transparent exception translation: rethrows JPA PersistenceExceptions as Spring&#8217;s DataAccessExceptions</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring-Managed Transactions &amp; EntityManager</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Transparently participate in Spring-driven transactions:</p>
<div class="ulist">
<ul>
<li>
<p>Use a Spring FactoryBean for building the EntityManagerFactory</p>
</li>
<li>
<p>Inject an EntityManager reference with @PersistenceContext</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define a transaction manager</p>
<div class="ulist">
<ul>
<li>
<p>JpaTransactionManager / JtaTransactionManager</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">The repository.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class JpaCustomerRepository implements CustomerRepository {
	private EntityManager entityManager;

	@PersistenceContext <b class="conum">(1)</b>
	public void setEntityManager (EntityManager entityManager) {
		this. entityManager = entityManager;
	}

	public Customer findById(long orderId) {
		return entityManager.find(Customer.class, orderId); <b class="conum">(2)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Automatic injection of EM proxy.</p>
</li>
<li>
<p>Proxy resloves to EM when used.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">The configuration.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public LocalContainerEntityManagerFactoryBean entityManagerFactory() { ... }

@Bean
public CustomerRepository jpaCustomerRepository() {
	return new JpaCustomerRepository();
}

@Bean
public PlatformTransactionManager transactionManager(EntityManagerFactory emf) throws Exception {
	return new JpaTransactionManager(emf);
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/how_jpa.png" alt="how jpa">
</div>
<div class="title">Figure 6. How JPA works.</div>
</div>
<hr>
<div class="imageblock">
<div class="content">
<img src="./img/how_jta.png" alt="how jta">
</div>
<div class="title">Figure 7. How JTA works.</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_data_jpa"><a class="link" href="#_spring_data_jpa">13.4. Spring Data – JPA</a></h3>
<div class="paragraph">
<p>Spring Data reduces boiler plate code for data access. It provides <strong>instant repositories</strong> by <strong>annotating domain classes</strong>. Repositories are <strong>just interfaces</strong>. Spring implements it at runtime by scanning for <code>Repository&lt;T,K&gt;</code> interfaces. <strong>CRUD-methods are then auto-generated</strong>. It allows paging, custom queries and sorting.</p>
</div>
<div class="paragraph">
<p>To use it with JPA, annotate JPA Domain object as usual and define <code>@EnableJpaRepositories(basePackages=com.acme.**.repository")</code> in your configuration class. Spring Data provides similar annotations to JPA e.g., <code>@Document</code>, <code>@Region</code>, <code>@NodeEntity</code> as well as templates e.g., <code>MongoTemplate</code>, <code>GemfireTemplate</code>, <code>RedisTemplate</code>. Extend predefined repository interfaces with custom finders or any method from the <code>CrudRepository</code>. Implement  <code>PagingAndSortingRepository&lt;T, K&gt;</code> to add <code>Iterable&lt;T&gt; findAll(Sort)</code> and <code>Page&lt;T&gt; findAll(Pageable)</code>.</p>
</div>
<div class="paragraph">
<p>Auto-generated finders obey naming convention: <code>findBy&lt;DataMember&gt;&lt;Op&gt;</code> where <code>&lt;Op&gt;</code> can be Gt, Lt, Ne, Between, Like, etc.</p>
</div>
<div class="listingblock">
<div class="title">Extend predefined interfaces.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface CrudRepository&lt;T, ID&gt; extends Serializable&gt; extends Repository&lt;T, ID&gt; {
	public &lt;S extends T&gt; save(S entity);
	public &lt;S extends T&gt; Iterable&lt;S&gt; save(Iterable&lt;S&gt; entities);

	public T findOne(ID id);
	public Iterable&lt;T&gt; findAll();
	public void delete(ID id);
	public void delete(T entity);
	public void deleteAll();
}

public interface CustomerRepository extends CrudRepository&lt;Customer, Long&gt; {
	public Customer findByEmail(String someEmail); // No &lt;Op&gt; for Equals
	public Customer findByFirstOrderDateGt(Date someDate);
	public Customer findByFirstOrderDateBetween(Date d1, Date d2);

	@Query("select u from Customer u where u.emailAddress = ?1")
	Customer findByEmail(String email); // ?1 replaced by method param
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_7"><a class="link" href="#_summary_7">13.5. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Use 100% JPA to define entities and access data</p>
<div class="ulist">
<ul>
<li>
<p>Repositories have no Spring dependency</p>
</li>
<li>
<p>Spring Data Repositories need no code!</p>
</li>
</ul>
</div>
</li>
<li>
<p>Use Spring to configure JPA entity-manager factory</p>
<div class="ulist">
<ul>
<li>
<p>Smart proxy works with spring-driven transactions</p>
</li>
<li>
<p>Optional translation to DataAccessExceptions</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_web"><a class="link" href="#_spring_web">14. Spring Web</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Developing Modern Web Applications: Servlet Configuration, Product Overview</p>
</div>
<div class="sect2">
<h3 id="_introduction_3"><a class="link" href="#_introduction_3">14.1. Introduction</a></h3>
<div class="paragraph">
<p>Spring provides support in the Web layer (Spring MVC, Spring WebFlow, &#8230;&#8203;) and <strong>integrates well</strong> with any Java web framework.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_spring_in_web_applications"><a class="link" href="#_using_spring_in_web_applications">14.2. Using Spring in Web Applications</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring can be initialized within a webapp.</p>
<div class="ulist">
<ul>
<li>
<p>start up business services, repositories, etc.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Uses a standard servlet listener.</p>
<div class="ulist">
<ul>
<li>
<p>Initialization occurs befire any servlets execute.</p>
</li>
<li>
<p>application ready for user requests.</p>
</li>
<li>
<p>ApplicationContext.close() is called when the application is stopped.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configuration either via. WebApplicationInitializer or web.xml (see <a href="#web-application-initializer">Configuration via. WebApplicationInitializer.</a> and <a href="#web-xml-initializer">Configuration via. web.xml.</a>)</p>
</li>
</ul>
</div>
<div id="web-application-initializer" class="listingblock">
<div class="title">Configuration via. WebApplicationInitializer.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class MyWebAppInitializer extends AbstractContextLoaderInitializer {

	@Override
	protected WebApplicationContext createRootApplicationContext() {
		// Create the 'root' Spring application context
		AnnotationConfigWebApplicationContext rootContext
				= new AnnotationConfigWebApplicationContext();
		rootContext.getEnvironment().setActiveProfiles("jpa"); // optional
		rootContext.register(RootConfig.class);
		return rootContext;
	}
}</code></pre>
</div>
</div>
<div id="web-xml-initializer" class="listingblock">
<div class="title">Configuration via. web.xml.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;context-param&gt;
	&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
	&lt;param-value&gt;/WEB-INF/merchant-reporting-webapp-config.xml&lt;/param-value&gt;
&lt;/context-param&gt;
&lt;listener&gt;
	&lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/servlet_container_after_startup.png" alt="servlet container after startup" width="700">
</div>
<div class="title">Figure 8. Servlet container after starting up.</div>
</div>
<div class="listingblock">
<div class="title">Override <code>onStartup()</code> method to define servlets. You cannot access spring beans yet.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class MyWebAppInitializer extends AbstractContextLoaderInitializer {
	protected WebApplicationContext createRootApplicationContext() {
		// ...Same configuration.
   }

	public void onStartup(ServletContext container) {
		super.onStartup(container);
		// Register and map a servlet
		ServletRegistration.Dynamic svlt = container.addServlet(
				"myServlet",
				new TopSpendersReportGenerator());
		svlt.setLoadOnStartup(1);
		svlt.addMapping("/");
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Dependency Injection of Servlets</p>
<div class="ulist">
<ul>
<li>
<p>Suitable for web.xml or AbstractContextLoaderInitializer</p>
</li>
<li>
<p>Use <code>WebApplicationContextUtils</code> to get the Spring ApplicationContext via ServletContext.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring MVC Supports Dependency Injection</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_spring_web"><a class="link" href="#_overview_of_spring_web">14.3. Overview of Spring Web</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring MVC</p>
<div class="ulist">
<ul>
<li>
<p>Web framework bundled with Spring</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring WebFlow</p>
<div class="ulist">
<ul>
<li>
<p>Plugs into Spring MVC</p>
</li>
<li>
<p>Implements navigation flows</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Mobile</p>
<div class="ulist">
<ul>
<li>
<p>Routing between mobile / non-mobile versions of site</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Social</p>
<div class="ulist">
<ul>
<li>
<p>Easy integration with Facebook, Twitter, etc.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_8"><a class="link" href="#_summary_8">14.4. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring can be used with any web framework</p>
<div class="ulist">
<ul>
<li>
<p>Spring provides the ContextLoaderListener that can be declared in web.xml</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring MVC is a lightweight web framework where controllers are Spring beans</p>
</li>
<li>
<p>WebFlow plugs into Spring MVC as a Controller technology for implementing stateful "flows"</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rest"><a class="link" href="#_rest">15. REST</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>REpresentational State Transfer</p>
</div>
<div class="sect2">
<h3 id="_rest_introduction"><a class="link" href="#_rest_introduction">15.1. REST introduction</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">General</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Web apps not just usable by browser clients.</p>
</li>
<li>
<p>REST is an architectural style that describes best practices to expose web services over HTTP.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Principles</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Expose resources through URIs.</p>
</li>
<li>
<p>Resources support limited set of operations.</p>
<div class="ulist">
<ul>
<li>
<p>GET, PUT, POST, DELETE in case of HTTP.</p>
</li>
<li>
<p>All have well-defined semantics.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Clients can request particular representation.</p>
<div class="ulist">
<ul>
<li>
<p>Resources can support multiple representations.</p>
</li>
<li>
<p>HTML, XML, JSON, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>Representations can link to other resources.</p>
<div class="ulist">
<ul>
<li>
<p>Allows for extensions and discovery, like with web sites</p>
</li>
</ul>
</div>
</li>
<li>
<p>Rest extended: Hypermedia As The Engine of Application State (HATEOAS)</p>
</li>
<li>
<p>Stateless architecture</p>
<div class="ulist">
<ul>
<li>
<p>No HttpSession usage</p>
</li>
<li>
<p>GETs can be cached on URL</p>
</li>
<li>
<p>Requires clients to keep track of state</p>
</li>
<li>
<p>Part of what makes it scalable</p>
</li>
<li>
<p>Looser coupling between client and server</p>
</li>
</ul>
</div>
</li>
<li>
<p>HTTP headers and status codes communicate result to clients.</p>
<div class="ulist">
<ul>
<li>
<p>All well-defined in HTTP Specification.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Benefits</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Every platform/language supports HTTP.</p>
</li>
<li>
<p>Scalability.</p>
</li>
<li>
<p>Support for redirect, caching, different representations, resource identification, &#8230;&#8203;</p>
</li>
<li>
<p>Support for multiple formats e.g., XML.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_rest_and_java"><a class="link" href="#_rest_and_java">15.2. REST and Java</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">General</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring-MVC provides REST support as well.</p>
</li>
<li>
<p>RestTemplate for building programmatic clients in Java.</p>
</li>
<li>
<p>Single web-application for everything.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_spring_mvc_support_for_restful_applications"><a class="link" href="#_spring_mvc_support_for_restful_applications">15.3. Spring MVC support for RESTful applications</a></h3>
<div class="sect3">
<h4 id="_request_response_processing"><a class="link" href="#_request_response_processing">15.3.1. Request/Response Processing</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Request Mapping based on HTTP Method</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Can map HTTP requests based on method</p>
</li>
<li>
<p>Allows same URL to be mapped to multiple methods</p>
</li>
<li>
<p>Often used for form-based controllers (GET &amp; POST)</p>
<div class="ulist">
<ul>
<li>
<p>Essential to support RESTful resource URLs</p>
<div class="ulist">
<ul>
<li>
<p>incl. PUT and DELETE</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">HTTP Status Code Support</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Web apps just use a handful of status codes.</p>
<div class="ulist">
<ul>
<li>
<p>Success: 200 OK</p>
</li>
<li>
<p>Redirect: 302/303 for Redirects</p>
</li>
<li>
<p>Client Error: 404 Not Found</p>
</li>
<li>
<p>Server Error: 500 (such as unhandled Exceptions)</p>
</li>
</ul>
</div>
</li>
<li>
<p>RESTful applications use many additional codes to communicate with their clients.</p>
</li>
<li>
<p>Add `@ResponseStatus`to controller method.</p>
<div class="ulist">
<ul>
<li>
<p>Don&#8217;t have to set status on HttpServletResponse manually.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When using @ResponseStatus, void methods no longer imply a default view name. The reponse body will be empty.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Determining Location Header</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Location header value must be full URL.</p>
<div class="ulist">
<ul>
<li>
<p>Determine based on request URL.</p>
<div class="ulist">
<ul>
<li>
<p>Controller shouldn&#8217;t know host name or servlet path.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>URL of created child resource usually a sub-path.</p>
<div class="ulist">
<ul>
<li>
<p>POST to <a href="http://www.myshop.com/store/orders" class="bare">http://www.myshop.com/store/orders</a> gives <a href="http://www.myshop.com/store/orders/123" class="bare">http://www.myshop.com/store/orders/123</a></p>
</li>
<li>
<p>Use Spring&#8217;s `UriTemplate`to ensure new URL is valid.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Exception Handling</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Define  @ResponseStatus directly on a exception class.</p>
</li>
<li>
<p>For existing exceptions you cannot annotate, use @ExceptionHandler method on controller.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Request mappings.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RequestMapping(value="/orders", method=RequestMethod.GET)
public void listOrders(Model model) {
	// find all Orders and add them to the model
}

@RequestMapping(value="/orders", method=RequestMethod.POST)
public void createOrder(HttpServletRequest request, Model model) {
	// process the order data from the request
}

@RequestMapping(value="/orders", method=RequestMethod.POST)
@ResponseStatus(HttpStatus.CREATED) // 201
public void createOrder(HttpServletRequest request, HttpServletResponse response) {
	Order order = createOrder(request);
	// determine full URI for newly created Order based on request
	response.addHeader("Location", getLocationForChildResource(request, order.getId()));
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Determining the location header.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">String getLocationForChildResource(HttpServletRequest request, Object childIdentifier) {
	StringBuffer url = request.getRequestURL();
	UriTemplate template = new UriTemplate(url.append("/{childId}").toString());
	return template.expand(childIdentifier).toASCIIString();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Can also annotate exception classes with @ResponseStatus.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ResponseStatus(HttpStatus.NOT_FOUND) // 404
public class OrderNotFoundException extends RuntimeException { ... }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exception handler.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ResponseStatus(HttpStatus.CONFLICT) // 409
@ExceptionHandler({DataIntegrityViolationException.class}) public void conflict() {
	// could add the exception, response, etc. as method params
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_messageconverters"><a class="link" href="#_using_messageconverters">15.3.2. Using MessageConverters</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">HttpMessageConverter</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Converts between HTTP request/response and object.</p>
</li>
<li>
<p>Various implementations registered by default when using <code>@EnableWebMvc</code> or <code>&lt;mvc:annotation-driven/&gt;</code>.</p>
</li>
<li>
<p>Define HandlerAdapter explicitly to register other HttpMessageConverters.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@RequestBody</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Enables converters for request data.</p>
</li>
<li>
<p>Right converter chosen automatically.</p>
<div class="ulist">
<ul>
<li>
<p>Based on content type of request.</p>
</li>
<li>
<p>Order could be mapped from XML with JAXB2 or from JSON with Jackson, for example.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@ResponseBody</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Use converters for response data by annotating method with @ResponseBody</p>
<div class="ulist">
<ul>
<li>
<p>Converter handles rendering to response</p>
</li>
<li>
<p>No ViewResolver and View involved anymore!</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Automatic Content Negotiation</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>HttpMessageConverter selected automatically.</p>
<div class="ulist">
<ul>
<li>
<p>For @Request/ResponseBody annotated parameters.</p>
</li>
<li>
<p>Each converter has list of supported media types.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Allows multiple representations for a single controller method.</p>
<div class="ulist">
<ul>
<li>
<p>Without affecting controller implementation.</p>
</li>
<li>
<p>Alternative to using Views.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Flexible media-selection.</p>
<div class="ulist">
<ul>
<li>
<p>Based on Accept header in HTTP request, or URL suffix, or URL format parameter.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_9"><a class="link" href="#_summary_9">15.4. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>REST is an architectural style that can be applied to HTTP-based applications.</p>
<div class="ulist">
<ul>
<li>
<p>Useful for supporting diverse clients and building highly scalable systems.</p>
</li>
<li>
<p>Java provides JAX-RS as standard specification.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring-MVC adds REST support using a familiar programming model.</p>
<div class="ulist">
<ul>
<li>
<p>Extended by @Request-/@ResponseBody.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Use RestTemplate for accessing RESTful apps.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_mvc"><a class="link" href="#_spring_mvc">16. Spring MVC</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Web framework based on the Model/View/Controller pattern.</p>
</div>
<div class="sect2">
<h3 id="_request_processing_lifecycle"><a class="link" href="#_request_processing_lifecycle">16.1. Request Processing Lifecycle</a></h3>
<div class="ulist">
<ul>
<li>
<p>Web request handling based on an incoming URL&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>&#8230;&#8203;we need to call a method&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;after which the return value (if any)&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;needs to be rendered using a view</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/request_processing_lifecycle.png" alt="request processing lifecycle" width="700">
</div>
<div class="title">Figure 9. Request Processing Lifecycle.</div>
</div>
</div>
<div class="sect2">
<h3 id="_key_artifacts"><a class="link" href="#_key_artifacts">16.2. Key Artifacts</a></h3>
<div class="sect3">
<h4 id="_dispatcherservlet"><a class="link" href="#_dispatcherservlet">16.2.1. DispatcherServlet</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">General</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A “front controller”</p>
<div class="ulist">
<ul>
<li>
<p>coordinates all request handling activities</p>
</li>
<li>
<p>analogous to Struts ActionServlet / JSF FacesServlet</p>
</li>
</ul>
</div>
</li>
<li>
<p>Delegates to Web infrastructure beans</p>
</li>
<li>
<p>Invokes user Web components</p>
</li>
<li>
<p>Fully customizable</p>
<div class="ulist">
<ul>
<li>
<p>interfaces for all infrastructure beans</p>
</li>
<li>
<p>many extension points</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuration</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Defined in web.xml or WebApplicationInitializer</p>
</li>
<li>
<p>Uses Spring for its configuration</p>
<div class="ulist">
<ul>
<li>
<p>programming to interfaces + dependency injection</p>
</li>
<li>
<p>easy to swap parts in and out</p>
</li>
</ul>
</div>
</li>
<li>
<p>Creates separate “servlet” application context</p>
<div class="ulist">
<ul>
<li>
<p>configuration is private to DispatcherServlet</p>
</li>
</ul>
</div>
</li>
<li>
<p>Full access to the parent “root” context</p>
<div class="ulist">
<ul>
<li>
<p>instantiated via ContextLoaderListener</p>
<div class="ulist">
<ul>
<li>
<p>shared across servlets</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock right">
<div class="content">
<img src="./img/initializer.png" alt="initializer" width="300">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Web Initializer</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">ServletContainerInitializer</dt>
<dd>
<p>Interface from Servlet 3 specification, implement to initialize servlet system.</p>
</dd>
<dt class="hdlist1">SpringServletContainerInitialize</dt>
<dd>
<p>Spring&#8217;s implementation which, in turn, delegates to one or more &#8230;&#8203;</p>
</dd>
<dt class="hdlist1">WebApplicationInitializer</dt>
<dd>
<p>Base-class for all Spring MVC apps to implement for servlet configuration without web.xml.</p>
</dd>
<dt class="hdlist1">AbstractContextLoaderInitializer</dt>
<dd>
<p>Sets up a ContextLoaderListener, you provide root ApplicationContext.</p>
</dd>
<dt class="hdlist1">AbstractAnnotationConfigDispatcherServletInitializer</dt>
<dd>
<p>Defines a DispatcherServlet, assumes Java Config. You provide root and servlet Java config classes.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/contexts_after_startup.png" alt="contexts after startup" width="600">
</div>
</div>
<div class="listingblock">
<div class="title">Java Configuration. Beans defined in MVC context have acess to root context beans.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class MyWebInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {

	// Tell Spring what to use for the Root context:
	@Override
	protected Class&lt;?&gt;[] getRootConfigClasses() {
		return new Class&lt;?&gt;[]{ RootConfig.class };
	}

	// Tell Spring what to use for the DispatcherServlet context:
	@Override
	protected Class&lt;?&gt;[] getServletConfigClasses() {
		return new Class&lt;?&gt;[]{ MvcConfig.class };
	}

	// DispatcherServlet mapping:
	@Override
	protected String[] getServletMappings() {
		return new String[]{"/main/*"};
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_controllers"><a class="link" href="#_controllers">16.2.2. Controllers</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">General</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Annotate controllers with @Controller</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Request Mapping</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>@RequestMapping</code> tells Spring what method to execute when processing a particular request</p>
<div class="ulist">
<ul>
<li>
<p>Mapping rules typically URL-based, optionally using wild cards:</p>
<div class="ulist">
<ul>
<li>
<p><code>/login</code></p>
</li>
<li>
<p><code>/editAccount</code></p>
</li>
<li>
<p><code>/listAccounts.htm</code></p>
</li>
<li>
<p><code>/reward/<strong>/</strong>*</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Controller Method Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Pick parameters as you want.</p>
<div class="ulist">
<ul>
<li>
<p>HttpServletRequest, HttpSession, Principal &#8230;&#8203;</p>
</li>
<li>
<p>Model for sending data to the view.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Extracting Request Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Use @RequestParam annotation</p>
<div class="ulist">
<ul>
<li>
<p>Extracts parameter from the request</p>
</li>
<li>
<p>Performs type conversion</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Uri Templates</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Values can be extracted from request URLs</p>
<div class="ulist">
<ul>
<li>
<p>Based on URI Templates</p>
</li>
<li>
<p>not Spring-specific concept, used in many frameworks</p>
</li>
<li>
<p>Use <code>{&#8230;&#8203;}</code> placeholders and <code>@PathVariable</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Allows clean URLs without request parameters</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
public class AccountController {

	@RequestMapping("/listAccounts")
	public String list(Model model) { ... } <b class="conum">(1)</b>

	@RequestMapping("/showAccount")
	public String show(@RequestParam("entityId") long id, Model model) { ... } <b class="conum">(2)</b>

	@RequestMapping("/accounts/{accountId}")
	public String show(
			@PathVariable("accountId") long id, <b class="conum">(3)</b>
			@RequestHeader(“user-agent”)) String agent, <b class="conum">(4)</b>
			Model model) { ... }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Returns view name and holds data for view in method parameter.</p>
</li>
<li>
<p>Extract request parameters.</p>
</li>
<li>
<p>Extract path variables.</p>
</li>
<li>
<p>Or even request headers.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_views"><a class="link" href="#_views">16.2.3. Views</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">General</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A View renders web output.</p>
<div class="ulist">
<ul>
<li>
<p>Many built-in views available for JSPs, XSLT, templating approaches (Velocity, FreeMarker), etc.</p>
</li>
<li>
<p>View support classes for creating PDFs, Excel spreadsheets, etc.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Controllers typically return a 'logical view name' String.</p>
</li>
<li>
<p>ViewResolvers select View based on view name.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">View Resolvers</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The DispatcherServlet delegates to a ViewResolver to obtain View implementation based on view name.</p>
</li>
<li>
<p>The default ViewResolver treats the view name as a Web Application-relative file path</p>
<div class="ulist">
<ul>
<li>
<p>i.e. a JSP: /WEB-INF/reward/list.jsp</p>
</li>
</ul>
</div>
</li>
<li>
<p>Override this default by registering a ViewResolver bean with the DispatcherServlet</p>
<div class="ulist">
<ul>
<li>
<p>We will use InternalResourceViewResolver</p>
</li>
<li>
<p>Several other options available.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quick_start_2"><a class="link" href="#_quick_start_2">16.3. Quick Start</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Steps to developing a Spring MVC application</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy a Dispatcher Servlet (one-time only)</p>
</li>
<li>
<p>Implement a controller</p>
</li>
<li>
<p>Register the Controller with the DispatcherServlet</p>
</li>
<li>
<p>Implement the View(s)</p>
</li>
<li>
<p>Register a ViewResolver (optional, one-time only)</p>
</li>
<li>
<p>Deploy and test</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_boot"><a class="link" href="#_spring_boot">17. Spring Boot</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Starter POMS and Auto-Configuration</p>
</div>
<div class="sect2">
<h3 id="_what_is_spring_boot"><a class="link" href="#_what_is_spring_boot">17.1. What is Spring Boot?</a></h3>
<div class="paragraph">
<p>An <strong>opinionated runtime</strong> for Spring Projects which <strong>handles most low-level setup</strong> with <strong>support for different project types</strong> like web and batch. You only need 3 files to get a running Boot app:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dependency management e.g., <code>pom.xml</code></p>
</li>
<li>
<p>Spring MVC controller</p>
</li>
<li>
<p>Application launcher</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_definition_and_hello_world_example"><a class="link" href="#_definition_and_hello_world_example">17.1.1. Definition and Hello World example</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Opinionated Runtime</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring Boot uses sensible defaults, “opinions”, mostly based on the classpath contents.</p>
</li>
<li>
<p>For example</p>
<div class="ulist">
<ul>
<li>
<p>Sets up a JPA Entity Manager Factory if a JPA implementation is on the classpath.</p>
</li>
<li>
<p>Creates a default Spring MVC setup, if Spring MVC is on the classpath.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Everything can be overridden easily.</p>
<div class="ulist">
<ul>
<li>
<p>But most of the time not needed</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deployment</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Example bundles Tomcat inside the application and runs as <strong>executable jar</strong>.</p>
</li>
<li>
<p>Spring Boot apps can be deployed into an existing app server.</p>
<div class="ulist">
<ul>
<li>
<p>As familiar WAR file.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Example maven descriptor. Can also use gradle or Ant/Ivy.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; <b class="conum">(1)</b>
    &lt;version&gt;1.3.0.RELEASE&lt;/version&gt;
&lt;/parent&gt;
&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; <b class="conum">(2)</b>
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; <b class="conum">(3)</b>
    &lt;/dependency&gt;
	&lt;dependency&gt;
	     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
	     &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; <b class="conum">(4)</b>
	&lt;/dependency&gt;
&lt;/dependencies&gt;
&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
		&lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Defines properties e.g., <code>${spring.version=4.2}</code></p>
</li>
<li>
<p>Resolves ~16 JARs e.g., spring-boot-<strong>.jar, spring-core-</strong>.jar, even various web dependencies e.g., tomcat-*.jar</p>
</li>
<li>
<p>Spring MVC embedded tomcat. Version not needed. Defined by parent.</p>
</li>
<li>
<p>Resolves spring-test-<strong>.jar, junit-</strong>.jar, mockito-*.jar and various other test frameworks.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Spring MVC controller.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RestController
public class HelloController {

	@RequestMapping("/")
	public String hello() {
		return "Greetings from Spring Boot!"; <b class="conum">(1)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Returns a String as the HTTP response body.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Annotation class.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@SpringBootApplication <b class="conum">(1)</b>
public class Application {

	public static void main(String[] args) {
		SpringApplication.run(Application.class, args);
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Runs embedded tomcat.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_explained"><a class="link" href="#_spring_boot_explained">17.2. Spring Boot Explained</a></h3>
<div class="sect3">
<h4 id="_dependency_management"><a class="link" href="#_dependency_management">17.2.1. Dependency Management</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">How to use Spring Boot</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Add the appropriate Spring Boot dependencies.</p>
</li>
<li>
<p>The easiest is to use a dependency management tool Spring Boot works with Maven, Gradle, Ant/Ivy.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">General</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring Boot parent pom dfines key versions of dependencies and maven plugin.</p>
</li>
<li>
<p>Various starter POMs available for common Java enterprise framworks e.g., spring-boot-starter-[jdbc|jpa|batch].</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_auto_configuration"><a class="link" href="#_auto_configuration">17.2.2. Auto Configuration</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">@EnableAutoConfiguration</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Annotation on a Spring Java configuration class.</p>
<div class="ulist">
<ul>
<li>
<p>Causes Spring Boot to automatically create beans it thinks you need.</p>
</li>
<li>
<p>Usually based on classpath contents, can easily override.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@SpringBootApplication</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Very common to use @EnableAutoConfiguration, @Configuration, and @ComponentScan together.</p>
<div class="ulist">
<ul>
<li>
<p>@ComponentScan, with no arguments, scans the current package and its sub-packages.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// this...
@Configuration
@ComponentScan
@EnableAutoConfiguration
public class MyAppConfig { ... }

// ... vs this.
@SpringBootApplication
public class MyAppConfig { ... }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_containerless_applications"><a class="link" href="#_containerless_applications">17.2.3. Containerless Applications</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring Boot as a runtime</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring Boot can startup an embedded web server</p>
<div class="ulist">
<ul>
<li>
<p>You can run a web application from a JAR file!</p>
</li>
<li>
<p>Tomcat included in Web Starter</p>
</li>
</ul>
</div>
</li>
<li>
<p>Jetty can be used instead of Tomcat</p>
<div class="ulist">
<ul>
<li>
<p>In pom:</p>
<div class="ulist">
<ul>
<li>
<p>Exclude <code>spring-boot-starter-tomcat</code></p>
</li>
<li>
<p>Include <code>spring-boot-starter-jetty</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Why run Web-Application outside of a Container?</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>No separation of container config and app config.</p>
<div class="ulist">
<ul>
<li>
<p>They depend on each other anyway (like JNDI DS names, security config).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Apps mostly target to a specific container.</p>
<div class="ulist">
<ul>
<li>
<p>Why not include that already?</p>
</li>
</ul>
</div>
</li>
<li>
<p>Easier debugging and profiling.</p>
</li>
<li>
<p>Easier hot code replacement.</p>
</li>
<li>
<p>No special IDE support needed.</p>
</li>
<li>
<p>Familiar model for non-Java developers .</p>
</li>
<li>
<p>Recommended for Cloud Native applications.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_packaging"><a class="link" href="#_packaging">17.2.4. Packaging</a></h4>
<div class="ulist">
<ul>
<li>
<p>Spring Boot creates a single archive.</p>
<div class="ulist">
<ul>
<li>
<p>Jar or War.</p>
</li>
<li>
<p>Can also include the Application Server.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Can be executed with “java -jar yourapp.war”.</p>
</li>
<li>
<p>Gradle and Maven plugins available.</p>
</li>
<li>
<p>Produces:</p>
<div class="ulist">
<ul>
<li>
<p><code>*.jar</code>: Contains your code and all libs - executable.</p>
</li>
<li>
<p><code>*.jar.original</code>: Contains only your code.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Maven Packaging. Add the boot maven plugin to pom.xml.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_inside_of_a_servlet_container"><a class="link" href="#_spring_boot_inside_of_a_servlet_container">17.3. Spring Boot inside of a Servlet Container</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Your choice whether containerless or not</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Embedded container is just one feature of Spring Boot.</p>
</li>
<li>
<p>Traditional WAR also benefits a lot from Spring Boot.</p>
<div class="ulist">
<ul>
<li>
<p>Automatic Spring MVC setup, including DispatcherServlet.</p>
</li>
<li>
<p>Sensible defaults based on the classpath content.</p>
</li>
<li>
<p>Embedded container can be used during development.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Spring Boot in a Servlet Container</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring Boot can also run in any Servlet 3.x container</p>
<div class="ulist">
<ul>
<li>
<p>e.g., Tomcat 7+, Jetty 8+</p>
</li>
</ul>
</div>
</li>
<li>
<p>Only small changes required</p>
<div class="ulist">
<ul>
<li>
<p>Change artifact type to WAR (instead of JAR).</p>
</li>
<li>
<p>Extend SpringBootServletInitializer.</p>
</li>
<li>
<p>Override configure method.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Still no web.xml required</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring Boot WAR file</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring Boot produces hybrid WAR file.</p>
</li>
<li>
<p>Can still be executed with embedded Tomcat.</p>
<div class="ulist">
<ul>
<li>
<p>Using “java -jar yourapp.war”.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Traditional WAR file produced as well.</p>
<div class="ulist">
<ul>
<li>
<p>Without embedded Tomcat.</p>
</li>
<li>
<p>Just drop it in your application server web app directory</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Servlet Container and Containerless.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ComponentScan
@EnableAutoConfiguration
public class Application extends SpringBootServletInitializer {

	protected SpringApplicationBuilder configure( SpringApplicationBuilder application) {
		return application.sources(Application.class);
	}

	public static void main(String[] args) {
		SpringApplication.run(Application.class, args);
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ease_of_use_features"><a class="link" href="#_ease_of_use_features">17.4. Ease of Use Features</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Externalized Properties</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Easily consumable with Spring <code>PropertySource</code></p>
</li>
<li>
<p>Spring boot automatically looks for <code>application.properties</code> in the classpath root.</p>
</li>
<li>
<p>Starter POMs declare the properties to use (see reference documentation).</p>
</li>
<li>
<p>Override location of a file:</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">System.setProperty("spring.config.name", "myserver");
SpringApplication.run(Application.class, args);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring boot supports YAML configuration (application.yml).</p>
</li>
</ul>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Controlling Log Levels</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Boot can control the logging level</p>
<div class="ulist">
<ul>
<li>
<p>Just set it in application.properties</p>
</li>
</ul>
</div>
</li>
<li>
<p>Works with most frameworks e.g., Java Util Logging, Logback, Log4J and Log4J2.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Data Source Configuration</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Use either spring-boot-starter-jdbc or spring-boot-starter- data-jpa and include a JDBC driver on classpath.</p>
</li>
<li>
<p>Declare poroperties:</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">spring.datasource.url=jdbc:mysql://localhost/test
spring.datasource.username=dbuser
spring.datasource.password=dbpass
spring.datasource.driver-class-name=com.mysql.jdbc.Driver</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Web Application Convenience</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Boot automatically configures Spring MVC DispatcherServlet and @EnableWebMvc defaults.</p>
<div class="ulist">
<ul>
<li>
<p>When spring-webmvc*.jar on classpath.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Static resources served from classpath.</p>
<div class="ulist">
<ul>
<li>
<p>/static, /public, /resources or /META-INF/resources.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Templates served from /templates.</p>
<div class="ulist">
<ul>
<li>
<p>When Velocity, Freemarker, Thymeleaf, or Groovy on classpath.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Provides default /error mapping.</p>
<div class="ulist">
<ul>
<li>
<p>Easily overridden.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_summary_10"><a class="link" href="#_summary_10">17.5. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring Boot speeds up Spring application development</p>
</li>
<li>
<p>You always have full control and insight</p>
</li>
<li>
<p>Nothing is generated</p>
</li>
<li>
<p>No special runtime requirements</p>
</li>
<li>
<p>No servlet container needed (if you want)</p>
<div class="ulist">
<ul>
<li>
<p>E.g. ideal for microservices</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_security"><a class="link" href="#_spring_security">18. Spring Security</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Addressing common Security Requirements.</p>
</div>
<div class="sect2">
<h3 id="_high_level_security_overview"><a class="link" href="#_high_level_security_overview">18.1. High-Level Security Overview</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Security Concepts</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><strong>Principal</strong>: User, device or system that performs an action.</p>
</li>
<li>
<p><strong>Authentication</strong>: Verifying that a principal&#8217;s credentials are valid.</p>
</li>
<li>
<p><strong>Authorization</strong>: Deciding whether a principal is allowed to perform an operation.</p>
</li>
<li>
<p><strong>Secured Item</strong>: Resource that is being secured.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Authentication</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>There are many authentication mechanisms.</p>
<div class="ulist">
<ul>
<li>
<p>e.g. basic, digest, form, X.509.</p>
</li>
</ul>
</div>
</li>
<li>
<p>There are many storage options for credential and authority information.</p>
<div class="ulist">
<ul>
<li>
<p>e.g. Database, LDAP, in-memory (development).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Authorization</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Authorization depends on authentication</p>
<div class="ulist">
<ul>
<li>
<p>Before deciding if a user can perform an action, user identity must be established.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The decision process is often based on roles.</p>
<div class="ulist">
<ul>
<li>
<p><em>ADMIN</em> can cancel orders.</p>
</li>
<li>
<p><em>MEMBER</em> can place orders.</p>
</li>
<li>
<p><em>GUEST</em> can browse the catalog.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_motivations_of_spring_security"><a class="link" href="#_motivations_of_spring_security">18.2. Motivations of Spring Security</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Motivation</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><strong>Spring Security is portable across containers</strong></p>
<div class="ulist">
<ul>
<li>
<p>Secured archive (WAR, EAR) can be deployed as-is.</p>
</li>
<li>
<p>Also runs in standalone environments.</p>
</li>
<li>
<p>Uses Spring for configuration.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Separation of Concerns</strong></p>
<div class="ulist">
<ul>
<li>
<p>Business logic is decoupled from security concerns.</p>
</li>
<li>
<p>Authentication and Authorization are decoupled.</p>
<div class="ulist">
<ul>
<li>
<p>Changes to the authentication process have no impact on authorization.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Flexibility</strong></p>
<div class="ulist">
<ul>
<li>
<p>Supports all common authentication mechanisms.</p>
<div class="ulist">
<ul>
<li>
<p>Basic, Form, X.509, Cookies, Single-Sign-On, etc.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configurable storage options for user details (credentials and authorities).</p>
<div class="ulist">
<ul>
<li>
<p>RDBMS, LDAP, custom DAOs, properties file, etc.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Extensible</strong></p>
<div class="ulist">
<ul>
<li>
<p>All the following can be customized.</p>
<div class="ulist">
<ul>
<li>
<p>How a principal is defined.</p>
</li>
<li>
<p>How authorization decisions are made.</p>
</li>
<li>
<p>Where security constraints are stored.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Consistency of Approach</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The goal of authentication is always the same regardless of the mechanism.</p>
<div class="ulist">
<ul>
<li>
<p>Establish a security context with the authenticated principal’s information.</p>
</li>
<li>
<p>Out-of-the-box this works for web applications.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The process of authorization is always the same regardless of resource type.</p>
<div class="ulist">
<ul>
<li>
<p>Consult the attributes of the secured resource.</p>
</li>
<li>
<p>Obtain principal information from security context.</p>
</li>
<li>
<p>Grant or deny access.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/spring_security.png" alt="spring security" width="700">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_security_in_a_web_environment"><a class="link" href="#_spring_security_in_a_web_environment">18.3. Spring Security in a Web Environment</a></h3>
<div class="listingblock">
<div class="title">Extend the WebSecurityConfigurerAdapter for easiest use.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableWebMvcSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception { ... } <b class="conum">(1)</b>

	@Autowired
	public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception { ... } <b class="conum">(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Web-specific security settings.</p>
</li>
<li>
<p>General security settings (authentication manager, &#8230;&#8203;).</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Authorize requests.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">protected void configure(HttpSecurity http) throws Exception {
	http.authorizeRequests()
			.antMatchers("/css/**","/images/**","/javascript/**").permitAll()
			.antMatchers("/accounts/edit*").hasRole("ADMIN")
			.antMatchers("/accounts/account*").hasAnyRole("USER",”ADMIN”)
			.antMatchers("/accounts/**").authenticated()
			.antMatchers("/customers/checkout*").fullyAuthenticated()
			.antMatchers("/customers/**").anonymous();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Login and logout.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">protected void configure(HttpSecurity http) throws Exception {
	http
			.authorizeRequests()
			.antMatchers("/aaa*").hasRole("ADMIN")
			.and() // method chaining

			.formLogin() // form-based authentication
			.loginPage("/login.jsp") // login url
			.permitAll() // any user can access
			.and()

			.logout() // logout for...
			.permitAll(); // ... any user
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example login page.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;c:url var=’loginUrl’value=’/login.jsp’ /&gt; <b class="conum">(1)</b>
&lt;form:form action=“${loginUrl}” method=“POST”&gt;
	&lt;input type=“text” name=“username”/&gt; <b class="conum">(2)</b>
	&lt;br/&gt;
	&lt;input type=“password” name=“password”/&gt; <b class="conum">(2)</b>
	&lt;br/&gt;
	&lt;input type=“submit” name=“submit” value=“LOGIN”/&gt;
&lt;/form:form&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>URL that indicates an authentication request. Default: POST against URL used to display the page.</p>
</li>
<li>
<p>The expected keys for generation of an authentication request token.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_web_authentication"><a class="link" href="#_configuring_web_authentication">18.4. Configuring Web Authentication</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Authentication Provider</dt>
<dt class="hdlist1">* DAO Authentication provider (default)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Expects a UserDetailsService implementation to provide credentials and authorities</p>
<div class="ulist">
<ul>
<li>
<p>Built-in: In-memory (properties), JDBC (database), LDAP</p>
</li>
<li>
<p>Custom</p>
<div class="ulist">
<ul>
<li>
<p>Custom Authentication provider</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Example: to get pre-authenticated user details when using single sign-on</p>
<div class="ulist">
<ul>
<li>
<p>CAS, TAM, SiteMinder &#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>Use a UserDetailsManagerConfigurer</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Three built in options:</p>
<div class="ulist">
<ul>
<li>
<p>LDAP, JDBC, in-memory (for quick testing)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Or use your own UserDetailsService implementation</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Sourcing Users from a Database</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Queries RDBMS for users and their authorities.</p>
<div class="ulist">
<ul>
<li>
<p>Provides default queries.</p>
<div class="ulist">
<ul>
<li>
<p><code>SELECT username, password, enabled FROM users WHERE username = ?</code></p>
</li>
<li>
<p><code>SELECT username, authority FROM authorities WHERE username = ?</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Groups also supported.</p>
<div class="ulist">
<ul>
<li>
<p>groups, group_members, group_authorities tables.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Advantage.</p>
<div class="ulist">
<ul>
<li>
<p>Can modify user info while system is running</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Password Encoding</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Can encode passwords using a hash.</p>
<div class="ulist">
<ul>
<li>
<p>sha, md5, bcrypt</p>
</li>
</ul>
</div>
</li>
<li>
<p>Always secure passwords with salts.</p>
<div class="ulist">
<ul>
<li>
<p>Makes brute force attacks harder.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Other Authentication Options</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Implement a custom UserDetailsService .</p>
<div class="ulist">
<ul>
<li>
<p>Delegate to an existing User repository or DAO.</p>
</li>
</ul>
</div>
</li>
<li>
<p>LDAP</p>
</li>
<li>
<p>X.509 Certificates</p>
</li>
<li>
<p>JAAS Login Module</p>
</li>
<li>
<p>Single-Sign-On</p>
<div class="ulist">
<ul>
<li>
<p>OAuth, SAML</p>
</li>
<li>
<p>SiteMinder, Kerberos</p>
</li>
<li>
<p>JA-SIG Central Authentication Service</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Profile with Security Configuration.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class SecurityBaseConfig extends WebSecurityConfigurerAdapter {

	protected void configure(HttpSecurity http) throws Exception {
			http.authorizeRequests().antMatchers("/resources/**").permitAll();
	}
}

@Configuration
@EnableWebSecurity
@Profile(“development”) // use in-memory provider
public class SecurityDevConfig extends SecurityBaseConfig {

	@Autowired
	public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
		auth.inMemoryAuthentication()
				.withUser("hughie").password("hughie").roles("GENERAL");
	}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">In-memory vs. database authentication.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// Either in-memory e.g., for testing...
@Autowired
public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
	auth
			.inMemoryAuthentication() <b class="conum">(1)</b>
					.withUser("hughie").password("hughie").roles("GENERAL").and() <b class="conum">(2)</b>
					.withUser("dewey").password("dewey").roles("ADMIN").and()
					.withUser("louie").password("louie").roles("SUPPORT");
}

// ... or sourcing from a database
@Autowired DataSource dataSource;

public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
	auth.
			jdbcAuthentication()  <b class="conum">(3)</b>
			.dataSource(dataSource)
			.passwordEncoder(new StandardPasswordEncoder("sodium-chloride")); <b class="conum">(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Adds a <code>UserDetailsManagerConfigurer</code>.</p>
</li>
<li>
<p>User, password and supported roles.</p>
</li>
<li>
<p>Can customize queries using methods: <code>usersByUsernameQuery()</code>, <code>authoritiesByUsernameQuery()</code> , <code>groupAuthoritiesByUsername()</code></p>
</li>
<li>
<p>SHA-256 encoded passwords with a salt.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_using_spring_security_s_tag_libraries"><a class="link" href="#_using_spring_security_s_tag_libraries">18.5. Using Spring Security&#8217;s Tag Libraries</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Tag Library Declatation</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In JSP: ` &lt;%@ taglib prefix="security" uri="http://www.springframework.org/security/tags" %&gt;`</p>
</li>
<li>
<p>Facelet tags for JSF are also available.</p>
<div class="ulist">
<ul>
<li>
<p>You need to define and install them manually</p>
</li>
<li>
<p>See “Using the Spring Security Facelets Tag Library” in the Spring Webflow documentation.</p>
</li>
<li>
<p>Principal is available in SpEL: #{principal.username}.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SpringSecurity&#8217;s Tag Library</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Display properties of the Authentication object</p>
</li>
<li>
<p>Hide sections of output based on role.</p>
<div class="ulist">
<ul>
<li>
<p>Role must be prefixed ROLE_ here.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">You are logged as:
&lt;security:authentication property=“principal.username”/&gt;

&lt;security:authorize access=“hasRole('ROLE_MANAGER')”&gt; <b class="conum">(1)</b>
	TOP-SECRET INFORMATION
	Click &lt;a href=“/admin/deleteAll”&gt;HERE&lt;/a&gt; to delete all records.
&lt;/security:authorize&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Alternatively define this <strong>centralized as intercept-URL</strong>: <code>.antMatchers("/admin/*").hasAnyRole("MANAGER",”ADMIN”)</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_method_security"><a class="link" href="#_method_security">18.6. Method security</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">General</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring Security uses AOP for security at the method level.</p>
<div class="ulist">
<ul>
<li>
<p>Annotations based on Spring annotations or JSR-250 annotations.</p>
</li>
<li>
<p>Java configuration to activate detection of annotations.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Typically secure your services.</p>
<div class="ulist">
<ul>
<li>
<p>Do not access repositories directly, bypasses security (and transactions).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">JSR-250 (Method Security). Not limited to roles. SpEL not supported.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@EnableGlobalMethodSecurity(jsr250Enabled=true) // on config class

...

import javax.annotation.security.RolesAllowed;

public class ItemManager {

	@RolesAllowed({"ROLE_MEMBER", "ROLE_USER"})
	public Item findItem(long itemNumber) { ... }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Method security with SpEL. Use Pre/Post annotations.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@EnableGlobalMethodSecurity(prePostEnabled=true)

...

import org.springframework.security.annotation.PreAuthorize;

public class ItemManager {

	 @PreAuthorize("hasRole('ROLE_MEMBER')")
	public Item findItem(long itemNumber) { ... }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_security_filters"><a class="link" href="#_advanced_security_filters">18.7. Advanced security: Filters</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring Security in a Web Environment</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>SpringSecurityFilterChain is declared in <code>web.xml</code>.</p>
</li>
<li>
<p>This single proxy filter delegates to a chain of Spring- managed filters..</p>
<div class="ulist">
<ul>
<li>
<p>Drive authentication.</p>
</li>
<li>
<p>Enforce authorization.</p>
</li>
<li>
<p>Manage logout.</p>
</li>
<li>
<p>Maintain SecurityContext in HttpSession.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/web_sec_filter_config.png" alt="web sec filter config" width="600">
</div>
<div class="title">Figure 10. Web Security Filter Configuration.</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Filter Chain</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>With ACEGI Security 1.x</p>
<div class="ulist">
<ul>
<li>
<p>Filters were manually configured as individual &lt;bean&gt; elements.</p>
</li>
<li>
<p>Led to verbose and error-prone XML.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Security 2.x and 3.x</p>
<div class="ulist">
<ul>
<li>
<p>Filters are initialized with correct values by default.</p>
</li>
<li>
<p>Manual configuration is not required <strong>unless you want to customize</strong> Spring Security&#8217;s behavior.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Custom Filter Chain</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Filter can be added to the chain.</p>
<div class="ulist">
<ul>
<li>
<p>Before or after existing filter.</p>
</li>
<li>
<p><code>http.addFilterAfter ( myFilter, UsernamePasswordAuthenticationFilter.class );</code></p>
</li>
<li>
<p>Just implement a <code>Filter</code> bean.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Filter on the stack may be replaced by a custom filter</p>
<div class="ulist">
<ul>
<li>
<p>Replacement must extend the filter being replaced.</p>
</li>
<li>
<p><code>http.addFilterAfter ( myFilter, UsernamePasswordAuthenticationFilter.class );</code></p>
</li>
<li>
<p><code>public class MySpecialFilter extends UsernamePasswordAuthenticationFilter {}</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/access_unsecured.png" alt="access unsecured" width="700">
</div>
<div class="title">Figure 11. Access unsecured resource prior to login.</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/access_secured.png" alt="access secured" width="700">
</div>
<div class="title">Figure 12. Access secured resource prior to login.</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/submit_login_request.png" alt="submit login request" width="600">
</div>
<div class="title">Figure 13. Submit Login Request.</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/access_res_with_with_req_role.png" alt="access res with with req role" width="700">
</div>
<div class="title">Figure 14. Access Resource With Required Role.</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/access_res_without_req_role.png" alt="access res without req role" width="700">
</div>
<div class="title">Figure 15. Access Resource Without Required Role.</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/submit_logout_request.png" alt="submit logout request" width="600">
</div>
<div class="title">Figure 16. Submit Logout Request.</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Summary.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">#</th>
<th class="tableblock halign-left valign-top">Filter Name</th>
<th class="tableblock halign-left valign-top">Main Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SecurityContextIntegrationFilter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Establishes SecurityContext and maintains between HTTP requests (formerly: HttpSessionContextIntegrationFilter)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LogoutFilter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clears SecurityContextHolder when logout requested</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UsernamePassword AuthenticationFilter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Puts Authentication into the SecurityContext on login request (formerly: AuthenticationProcessingFilter)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception TranslationFilter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts SpringSecurity exceptions into HTTP response or redirect</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FilterSecurity Interceptor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorizes web requests based on on config attributes and authorities</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_microservices_and_cloud_embeded_systems"><a class="link" href="#_microservices_and_cloud_embeded_systems">19. Microservices and Cloud embeded Systems</a></h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Building Cloud Native Applications.</p>
</div>
<div class="sect2">
<h3 id="_what_are_microservices"><a class="link" href="#_what_are_microservices">19.1. What are Microservices?</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Three Tier Architecture</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Single “monolithic” application that does everything.</p>
</li>
<li>
<p>Single, large development team.</p>
</li>
<li>
<p>Separate Ops, DBAs, Dev teams.</p>
</li>
<li>
<p>All data in single relational database.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Microservice Features</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Multi-Language</p>
<div class="ulist">
<ul>
<li>
<p>Not all the services need to be in the same language / framework</p>
</li>
</ul>
</div>
</li>
<li>
<p>Polyglot Persistence</p>
<div class="ulist">
<ul>
<li>
<p>Each service uses the most suitable storage system.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Stand-alone Development</p>
<div class="ulist">
<ul>
<li>
<p>Develop, Test and Deploy each service independently.</p>
</li>
<li>
<p>Separate teams, leverage Dev Ops.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Trade-Offs.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Single App</th>
<th class="tableblock halign-left valign-top">Microservices</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Easier to build</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Harder to build</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Large process to deploy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network Overheads</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ultimately more complex to enhance and maintain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ultimately simpler to enhance and maintain</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scaling Up (bigger processors) limited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scaling Out (more processes) easier</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Core Spring Architectural Concepts</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring emphasizes</p>
<div class="ulist">
<ul>
<li>
<p>Loose Coupling</p>
<div class="ulist">
<ul>
<li>
<p>Applications are built from collaborating services (processes).</p>
</li>
<li>
<p>Similar to Service Oriented Architectures (SOA).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tight Cohesion</p>
<div class="ulist">
<ul>
<li>
<p>An application (service) that deals with a single view of data.</p>
</li>
<li>
<p>Also known as “Bounded Contexts” (Domain-Driven Design).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Why Cloud, Why PaaS (Platform as a Service)?</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Deploying multiple processes is complicated.</p>
<div class="ulist">
<ul>
<li>
<p>Security, resilience, redundancy, load-balancing.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A Cloud (PaaS) provides the necessary tools.</p>
<div class="ulist">
<ul>
<li>
<p>Natural fit for deploying a microservice-based system.</p>
</li>
<li>
<p>Application is the unit of deployment.</p>
</li>
<li>
<p>Application instances are the unit of scaling.</p>
</li>
<li>
<p>Start, stop and restart apps independently, on-demand.</p>
</li>
<li>
<p>Provide dynamic load-balancing, scaling and routing.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Cloud Native Applications</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Applications</p>
<div class="ulist">
<ul>
<li>
<p>Designed to run “in the cloud”.</p>
</li>
<li>
<p>In isolated, disposable containers.</p>
<div class="ulist">
<ul>
<li>
<p>Fast to scale-up and scale-down.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Make no assumptions about the underlying infrastructure.</p>
<div class="ulist">
<ul>
<li>
<p>Local file-system transient.</p>
</li>
<li>
<p>Sessions lost on restart.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Should design applications to suit this environment.</p>
<div class="ulist">
<ul>
<li>
<p>Use <a href="http://12factor.net">Twelve Factor Application design patterns</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Why Spring Boot?</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Faster to develop than traditional Spring.</p>
</li>
<li>
<p>Java apps become as easy as Grails or Rails apps.</p>
<div class="ulist">
<ul>
<li>
<p>But with JVM robustness and scalability.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Easy to incorporate other Spring modules.</p>
<div class="ulist">
<ul>
<li>
<p>As listed on previous slide.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Cloud requires Spring Boot.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_challenges_and_implementation"><a class="link" href="#_challenges_and_implementation">19.2. Challenges and Implementation</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Create a new Microservice App</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Start with Monolith</p>
</li>
<li>
<p>As it grows:</p>
<div class="ulist">
<ul>
<li>
<p>Decompose into micro-service(s).</p>
</li>
<li>
<p>Enables separately manageable and deployable units.</p>
</li>
<li>
<p>Each can use own storage solution (polyglot persistence).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Decompose an existing Monolith</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Develop new functionality as microservice(s) around existing single-process application.</p>
</li>
<li>
<p>Refactor existing monolith functionality into new microservice(s).</p>
<div class="ulist">
<ul>
<li>
<p>Refactor at service layer.</p>
</li>
<li>
<p>Monolith service communicates over an agreed protocol e.g., HTML with the new microservice.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_spring_cloud"><a class="link" href="#_spring_cloud">19.3. Spring Cloud</a></h3>
<div class="sect3">
<h4 id="_overview"><a class="link" href="#_overview">19.3.1. Overview</a></h4>
<div class="ulist">
<ul>
<li>
<p>Building blocks for Cloud and Microservice applications.</p>
<div class="ulist">
<ul>
<li>
<p>Microservices Infrastructure.</p>
<div class="ulist">
<ul>
<li>
<p>Wraps up and makes available useful services.</p>
</li>
<li>
<p>Several based on other Open Source projects e.g., Netfix, HashiCorp&#8217;s Consul</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cloud Independence.</p>
<div class="ulist">
<ul>
<li>
<p>Access cloud-specific information and services.</p>
</li>
<li>
<p>Support for Cloud Foundry, AWS and Heroku.</p>
</li>
<li>
<p>Or run without any cloud at all.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Uses Spring Boot starters.</p>
<div class="ulist">
<ul>
<li>
<p>Requires Spring Boot to work.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring Cloud Projects</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>IaaS Integration</p>
</li>
<li>
<p>Dynamic Reconfiguration</p>
</li>
<li>
<p>Service Discovery / Load Balancing</p>
</li>
<li>
<p>Utilities</p>
</li>
<li>
<p>Data Ingestion</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Communication between Microservices</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Rest / JSON typically used.</p>
<div class="ulist">
<ul>
<li>
<p>How do Services find each other?</p>
</li>
<li>
<p>What happens if we run mutliple instances?</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Registry Servers for Microservices</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Two popular open-source registry services.</p>
<div class="ulist">
<ul>
<li>
<p>Eureka (Netflix)</p>
</li>
<li>
<p>Consul.io (Vagrant)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring cloud makes it easy to use either of or switch between them.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Spring Cloud Maven descriptor.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;parent&gt;
	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; // Parent
	&lt;artifactId&gt;spring-cloud-starter-parent&lt;/artifactId&gt;
	&lt;version&gt;Angel.SR3&lt;/version&gt; // Consolidated set of releases.
&lt;/parent&gt;
    &lt;dependencies&gt;
    	&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
        	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; // Spring Cloud
			&lt;artifactId&gt;spring-cloud-starter&lt;/artifactId&gt;
		&lt;/dependency&gt;
   		&lt;dependency&gt;
        	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt; // Eureka regostry server.
		&lt;/dependency&gt;
	&lt;/dependencies&gt;
...</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Building a Microservice System</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run a Discovery Service.</p>
</li>
<li>
<p>Run a Microservice.</p>
<div class="ulist">
<ul>
<li>
<p>Ensure it registers itself with the Discovery Service.</p>
</li>
</ul>
</div>
</li>
<li>
<p>How do Microservice clients find the service?</p>
<div class="ulist">
<ul>
<li>
<p>Inject a “smart” RestTemplate.</p>
<div class="ulist">
<ul>
<li>
<p>Spring performs service lookup for you.</p>
</li>
<li>
<p>Uses logical service names in URLs.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_eureka_service_discovery"><a class="link" href="#_eureka_service_discovery">19.3.2. Eureka Service Discovery</a></h4>
<div class="listingblock">
<div class="title">Eureka application class.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@EnableEurekaServer
public class EurekaApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
	}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Eureka configuration.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">server:
	port : 8761
eureka:
	instance:
		hostname: localhost
	client:  # Not a client
  		registerWithEureka: false
	  	fetchRegistry: false</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_service_registration"><a class="link" href="#_service_registration">19.3.3. Service Registration</a></h4>
<div class="ulist">
<ul>
<li>
<p>Each microservice declares itself a discovery-client.</p>
<div class="ulist">
<ul>
<li>
<p>Using <code>@EnableDiscoveryClient</code>.</p>
</li>
<li>
<p>Registers using its application name.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Service implementation.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@EnableDiscoveryClient
public class AccountsApplication {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
	}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Service discovery configuration.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">spring:
	application:
		name: accounts-microservice <b class="conum">(1)</b>
eureka:
	client:
 		serviceUrl:
			defaultZone: http://localhost:8761/eureka/ <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Service name.</p>
</li>
<li>
<p>Eureka server URL.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_service_discovery_client"><a class="link" href="#_service_discovery_client">19.3.4. Service Discovery Client</a></h4>
<div class="listingblock">
<div class="title">Discovery client with a smart Rest-Template.</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@EnableDiscoveryClient
public class FrontEndApplication {

	public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
	}

	@Bean
	public AccountManager accountManager() {
    	return new RemoteAccountManager();
	}
}

@Service
public class RemoteAccountManager {

	// Spring injects a “smart” service-aware template
	// configured with RibbonHttpRequestClient to do a
	// load-balanced lookup
	@Autowired
	@LoadBalanced
	RestTemplate restTemplate;

	public Account findAccount(String id) {
		// Fetch data
		return restTemplate.getForObject(
				"http://accounts-microservice/accounts/{id}", // service name
				Account.class,
				id);
	}
}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Intelligent Routing</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Spring Cloud automatically integrates two Netflix utilities.</p>
<div class="ulist">
<ul>
<li>
<p>“Eureka” service-discovery.</p>
</li>
<li>
<p>“Ribbon” load-balancer.</p>
</li>
</ul>
</div>
</li>
<li>
<p>End result</p>
<div class="ulist">
<ul>
<li>
<p>Determines the best available service to use (when there are multiple instances of a microservice).</p>
</li>
<li>
<p>Just inject the load-balanced RestTemplate.</p>
</li>
<li>
<p>Automatic lookup by logical service-name.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Check out</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="http://projects.spring.io/spring-cloud">Project Homepage</a></p>
</li>
<li>
<p><a href="https://github.com/mstine/2015-cfsummit-deploying-ms-to-cf">Matt Stine&#8217;s presentation from CF Summit</a></p>
</li>
<li>
<p><a href="https://spring.io/blog/2015/07/14/microservices-with-spring">Spring Blog Article</a></p>
</li>
<li>
<p><a href="https://github.com/mstine/intro-spring-cloud-workshop">Spring Cloud/Boot Demos</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_11"><a class="link" href="#_summary_11">19.4. Summary</a></h3>
<div class="ulist">
<ul>
<li>
<p>After completing this lesson, you should have learnt:</p>
<div class="ulist">
<ul>
<li>
<p>What is a Microservice Architecture?</p>
</li>
<li>
<p>Advantages and Challenges of Microservices.</p>
</li>
<li>
<p>Implementation using Spring Cloud projects.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-11-30 20:31:48 CET
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
</body>
</html>